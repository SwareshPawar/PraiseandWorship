<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Praise & Worship Songs</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- Replace current Font Awesome with version 4 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <!-- jQuery and jQuery UI -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"></script>
    <script>
        // Add this right after jQuery loads
        $(document).ajaxError(function(event, jqxhr, settings, thrownError) {
            if (settings.url && settings.url.includes('chrome-extension://invalid')) {
                event.preventDefault();
                return false;
            }
        });
    </script>
    <style>

        /* Add to your existing CSS */
        .song-preview {
            transition: transform 0.3s ease;
        }

        .swipe-left {
            transform: translateX(-100%);
            opacity: 0;
        }

        .swipe-right {
            transform: translateX(100%);
            opacity: 0;
        }

        /* Suggested Songs Drawer */
        .suggested-songs-drawer {
            position: fixed;
            top: 0;
            right: -350px;
            width: 350px;
            height: 100%;
            background: var(--light-bg);
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            z-index: 950;
            transition: right 0.3s ease;
            overflow-y: auto;
            padding: 20px;
            color: var(--text-color);
        }

        .suggested-songs-drawer.open {
            right: 0;
        }

        .suggested-songs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--song-item-border);
        }

        .sidebar, .songs-section, .preview-section {
            transition: all 0.3s ease;
        }

        .suggested-songs-header h3 {
            margin: 0;
            color:var(--text-color);
        }

        .close-suggested-songs {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
        }

        .suggested-song-item {
            padding: 12px;
            margin-bottom: 10px;
            background: var(--song-item-bg);
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--song-item-border);
        }

        .suggested-song-item:hover {
            transform: translateX(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .suggested-song-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .suggested-song-meta {
            font-size: 0.85rem;
            color: var(--song-meta-color);
        }

        .suggested-song-match {
            display: inline-block;
            margin-top: 5px;
            padding: 2px 8px;
            background: var(--accent-color);
            color: white;
            border-radius: 12px;
            font-size: 0.75rem;
        }

        .toggle-suggested-songs {
        position: fixed;
        right: 20px;
        top: 50px;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--accent-color);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 900;
        transition: all 0.3s;
        border: none;
    }

        .toggle-suggested-songs:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }


        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #166088;
            --accent-color: #4fc3f7;
            --text-color: #333;
            --light-bg: #f5f7fa;
            --delete-color: #e63946;
            --sidebar-width: 200px;
            --songs-panel-width: 200px;
            --preview-margin-left: 10px;
            --favorite-color: #ff6b6b;
            --notification-bg: rgba(0, 0, 0, 0.7);
            /* Dark mode variables */
            --dark-primary: #1a365d;
            --dark-secondary: #2c5282;
            --dark-accent: #4299e1;
            --dark-text: #e2e8f0;
            --dark-bg: #1a202c;
            --dark-light-bg: #2d3748;
            --dark-favorite: #ff8787;
            /* Theme variables */
            --sidebar-text-color: white;
            --sidebar-item-bg: transparent;
            --sidebar-item-hover-bg: var(--secondary-color);
            --sidebar-text-hover: white;
            --song-item-bg: white;
            --song-item-text: #333;
            --song-item-border: #e2e8f0;
            --song-meta-color: #666;
            --lyrics-bg-color: white;
            --lyrics-text-color: #333;
            --title-color: var(--primary-color);
            --chord-color: var(--primary-color);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            min-height: 100vh;
            color: var(--text-color);
            background: var(--light-bg);
            overflow-x: hidden;
            transition: background 0.3s, color 0.3s;
        }

            body.dark-mode {
                --primary-color: var(--dark-primary);
                --secondary-color: var(--dark-secondary);
                --accent-color: var(--dark-accent);
                --text-color: var(--dark-text);
                --light-bg: var(--dark-bg);
                --sidebar-text-color: #e2e8f0;
                --sidebar-item-bg: rgba(255, 255, 255, 0.05);
                --sidebar-item-hover-bg: var(--dark-secondary);
                --song-item-bg: #2d3748;
                --song-item-text: #e2e8f0;
                --song-item-border: #4a5568;
                --song-meta-color: #a0aec0;
                --lyrics-bg-color: #2d3748;
                --lyrics-text-color: #e2e8f0;
                --title-color: var(--accent-color);
                --chord-color: var(--accent-color);
                --favorite-color: var(--dark-favorite);
            }

        /* Add these styles to your existing CSS */
        .song-lyrics {
            padding: 15px;
            border-radius: 6px;
            border-style: inset;
            background-color: white;
            color: #000000;
            transition: background-color 0.3s, color 0.3s;
        }

        .song-preview h2 {
            color: var(--primary-color);
            transition: color 0.3s;
        }

        /* Dark mode variables */
        body.dark-mode .chord {
            color: #4fc3f7;
        }

        body.dark-mode {
            color: #cbd5e0;
            --song-meta-color: #a0aec0; /* Light gray-blue for dark mode */
        }

        /* Ensure chord colors work in both modes */
        .chord {
            color: var(--primary-color);
            transition: color 0.3s;
        }

        body.dark-mode {
            --chord-color: var(--accent-color);
        }

        /* App Layout */
        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Panel Toggles */
        .panel-toggle.draggable {
            position: fixed;
            z-index: 1100;
            padding: 8px;
            background: var(--accent-color);
            color: white;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            opacity: 0.9;
            transform: scale(1);
        }

        .sidebar-footer {
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .panel-toggle.draggable:hover,
        .panel-toggle.draggable.showing {
            transform: scale(1.1);
            opacity: 1;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .panel-toggle::after {
            content: '';
            position: absolute;
            top: -6px;
            right: -6px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--accent-color);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 0.8;
            }

            50% {
                transform: scale(1.5);
                opacity: 0.4;
            }

            100% {
                transform: scale(1);
                opacity: 0.8;
            }
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--primary-color);
            color: white;
            padding: 15px;
            position: fixed;
            left: 0;
            height: 100%;
            z-index: 1000;
            transition: transform 0.3s ease;
            overflow-y: auto;
        }

            .sidebar.hidden {
                transform: translateX(-100%);
            }

        .sidebar-header {
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-menu {
            list-style: none;
            padding: 10px 0;
        }

            .sidebar-menu li {
                margin: 8px 0;
            }

            .sidebar-menu a,
            .sidebar-btn {
                color: var(--sidebar-text-color);
                text-decoration: none;
                padding: 10px;
                display: flex;
                align-items: center;
                gap: 8px;
                border-radius: 4px;
                background: var(--sidebar-item-bg);
                border: none;
                width: 100%;
                cursor: pointer;
                transition: background 0.2s, transform 0.2s;
            }

                .sidebar-menu a:hover,
                .sidebar-menu a.active,
                .sidebar-btn:hover {
                    background: var(--sidebar-item-hover-bg);
                    color: var(--sidebar-text-hover);
                    transform: translateX(5px);
                }

        .sidebar-folder {
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .folder-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            cursor: pointer;
            font-weight: bold;
            padding: 10px;
            border-radius: 4px;
            background: var(--secondary-color);
            transition: background 0.3s ease;
        }

            .folder-toggle:hover {
                background: #0e4b6e;
            }

        .folder-caret {
            transition: transform 0.3s ease;
        }

        .folder-content {
            display: none;
            flex-direction: column;
            gap: 5px;
            margin-top: 10px;
            padding-left: 10px;
        }

            .folder-content.show {
                display: flex;
            }

        .folder-toggle.active .folder-caret {
            transform: rotate(180deg);
        }

        /* Songs Panel Styles */
        .songs-section {
            width: var(--songs-panel-width);
            background: var(--light-bg);
            padding: 10px;
            position: fixed;
            left: var(--sidebar-width);
            height: 100%;
            z-index: 900;
            transition: transform 0.3s ease;
            overflow-y: auto;
        }

            .songs-section.hidden {
                transform: translateX(-100%);
            }

        .sticky-header {
            position: sticky;
            top: 0;
            background: var(--light-bg);
            z-index: 100;
            padding: 10px 0;
        }

        .filters-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .compact-input,
        .compact-select {
            padding: 6px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 0.9rem;
            width: 100%;
        }

        /* Song Item Styles */
        .song-item {
            background: var(--song-item-bg);
            color: var(--song-item-text);
            margin: 10px 0;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            border: 1px solid var(--song-item-border);
            transition: all 0.3s ease;
            position: relative;
        }

            .song-item:hover {
                background: var(--sidebar-item-hover-bg);
                color: var(--sidebar-text-hover);
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            }

        .song-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .song-meta {
            color: var(--song-meta-color);
            font-size: 0.85rem;
            margin-bottom: 8px;
            transition: color 0.3s;
        }

        .song-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        /* Preview Section Styles */
        .preview-section {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            margin-left: calc(var(--sidebar-width) + var(--songs-panel-width) + var(--preview-margin-left));
            transition: margin-left 0.3s ease;
            z-index: 800;
            width: calc(100% - var(--sidebar-width) - var(--songs-panel-width) - var(--preview-margin-left) - 20px);
        }

            .preview-section.full-width {
                margin-left: var(--preview-margin-left);
                width: calc(100% - var(--preview-margin-left) - 20px);
            }

        .song-lyrics {
            white-space: pre-wrap;
            margin-top: 20px;
            line-height: 1.6;
            background: var(--lyrics-bg-color);
            color: var(--lyrics-text-color);
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .chord-line {
            margin-bottom: -4px;
            white-space: pre;
            font-weight: bold;
            color: var(--chord-color);
            margin-bottom: -1px;
        }


        .chord {
            color: var(--primary-color);
            font-weight: bold;
        }

        /* Button Styles */
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background 0.2s, transform 0.2s;
        }

            .btn:hover {
                transform: translateY(-1px);
            }

        .btn-primary {
            background: var(--accent-color);
            color: white;
        }

            .btn-primary:hover {
                background: var(--secondary-color);
            }

        .btn-edit {
            background: #2a9d8f;
            color: white;
        }

            .btn-edit:hover {
                background: #28796e;
            }

        .btn-delete {
            background: var(--delete-color);
            color: white;
        }

            .btn-delete:hover {
                background: #b32d37;
            }

        .btn-cancel {
            background: #6c757d;
            color: white;
        }

            .btn-cancel:hover {
                background: #5a6268;
            }

        .btn-favorite {
            background: var(--favorite-color);
            color: white;
        }

            .btn-favorite:hover {
                background: #ff5252;
            }

        /* Tab Styles */
        .tabs {
            display: flex;
            margin-bottom: 10px;
        }

        .tab {
            padding: 8px 15px;
            background: var(--primary-color);
            color: white;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            transition: background 0.2s;
        }

            .tab.active {
                background: var(--secondary-color);
            }

            .tab:hover {
                background: var(--secondary-color);
            }

        .tab-content {
            display: none;
        }

            .tab-content.active {
                display: block;
            }

        /* Setlist Tab Styles */
        .setlist-tabs {
            display: flex;
            border-bottom: 2px solid var(--primary-color);
            margin-bottom: 15px;
        }

        .setlist-tab {
            padding: 10px 20px;
            background: var(--primary-color);
            color: var(--text-color);
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
            font-weight: 500;
        }

            .setlist-tab.active {
                background: var(--primary-color);
                color: white;
            }

            .setlist-tab:hover {
                background: var(--secondary-color);
                color: white;
            }

        .setlist-content {
            background: white;
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .setlist-sortable li {
            cursor: grab;
            transition: background 0.3s;
        }

            .setlist-sortable li:hover {
                background-color: #e0f0ff;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            }

        .setlist-index {
            font-weight: bold;
            margin-right: 10px;
            color: var(--primary-color);
        }

        /* Search Styles */
        .scrollable-results {
            max-height: 60vh;
            overflow-y: auto;
        }

        #searchResultsContent {
            max-height: 60vh;       /* Limits height */
            overflow-y: auto;       /* Enables scroll */
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        #searchResultsContent .search-result-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }

        #searchResultsContent .search-result-item:hover {
            background-color: #f5f5f5;
        }
        
        .search-container {
            position: relative;
            width: 100%;
        }
        
        .clear-search-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #999;
            font-size: 1.2rem;
            transition: color 0.2s;
        }
        
        .clear-search-btn:hover {
            color: #666;
        }

        .search-history-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .search-history-item {
            padding: 8px 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

            .search-history-item:hover {
                background-color: #f5f5f5;
            }

        .search-history-header {
            padding: 8px 10px;
            font-weight: bold;
            border-bottom: 1px solid #eee;
            background-color: #f9f9f9;
        }

        .search-results {
            display: none;
            margin-top: 15px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 10px;
        }

            .search-results.active {
                display: block;
            }

        .search-results-header {
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }

        .search-result-item {
            padding: 8px;
            border-bottom: 1px solid #f5f5f5;
            cursor: pointer;
        }

            .search-result-item:hover {
                background-color: #f9f9f9;
            }

        .search-result-title {
            font-weight: 600;
        }

        .search-result-meta {
            font-size: 0.8rem;
            color: #666;
        }

        .search-result-snippet {
            font-size: 0.85rem;
            color: #555;
            margin-top: 4px;
            font-style: italic;
        }

        .highlight {
            background-color: yellow;
            font-weight: bold;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 70%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { 
                transform: translateY(20px);
                opacity: 0;
            }
            to { 
                transform: translateY(0);
                opacity: 1;
            }
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
            color: var(--text-color);
            background: var(--light-bg);
            border: 1px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }

            .close-modal:hover {
                background: var(--primary-color);
                color: white;
            }

        .add-song-form,
        .edit-song-form,
        .delete-song-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

            .add-song-form input,
            .add-song-form select,
            .add-song-form textarea,
            .edit-song-form input,
            .edit-song-form select,
            .edit-song-form textarea {
                padding: 8px;
                border-radius: 4px;
                border: 1px solid #ccc;
                transition: border-color 0.3s, box-shadow 0.3s;
            }

            .add-song-form input:focus,
            .add-song-form select:focus,
            .add-song-form textarea:focus,
            .edit-song-form input:focus,
            .edit-song-form select:focus,
            .edit-song-form textarea:focus {
                border-color: var(--accent-color);
                box-shadow: 0 0 0 2px rgba(79, 195, 247, 0.3);
                outline: none;
            }

            .add-song-form textarea,
            .edit-song-form textarea {
                height: 150px;
                resize: vertical;
                font-family: monospace;
                overflow-y: auto;
            }

        /* Settings Styles */
        #settingsBtn {
            position: absolute;
            bottom: 15px;
            left: 15px;
            padding: 6px 12px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            z-index: 1001;
            transition: all 0.3s ease;
        }

            #settingsBtn:hover {
                transform: scale(1.05);
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            }

        .draggable-menu-item {
            cursor: grab;
            user-select: none;
        }

        /* Auto-scroll controls */
        .auto-scroll-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .auto-scroll-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--accent-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            border: none;
        }

            .auto-scroll-btn:hover {
                transform: scale(1.1);
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            }

            .auto-scroll-btn.active {
                background: var(--secondary-color);
            }

        /* Notification */
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--notification-bg);
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            z-index: 1100;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

            .notification.show {
                opacity: 1;
            }

        /* Multi-select styles */
        .multiselect-container {
            position: relative;
        }

        .multiselect-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 4px 4px;
            z-index: 1000;
            display: none;
        }

            .multiselect-dropdown.show {
                display: block;
            }

        .multiselect-option {
            padding: 8px 10px;
            cursor: pointer;
        }

            .multiselect-option:hover {
                background-color: #f5f5f5;
            }

            .multiselect-option.selected {
                background-color: var(--accent-color);
                color: white;
            }

        .multiselect-selected {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }

        .multiselect-tag {
            background: var(--accent-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

            .multiselect-tag .remove-tag {
                cursor: pointer;
                font-size: 0.9rem;
            }

        /* Keep screen on button */
        .keep-screen-on {
            position: fixed;
            bottom: 70px;
            right: 20px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--accent-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            border: none;
            z-index: 1000;
        }

            .keep-screen-on:hover {
                transform: scale(1.1);
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            }

            .keep-screen-on.active {
                background: var(--secondary-color);
            }

        /* Favorite button */
        .favorite-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #ccc;
            cursor: pointer;
            font-size: 1.2rem;
            transition: color 0.2s;
        }

            .favorite-btn:hover {
                color: var(--favorite-color);
            }

            .favorite-btn.favorited {
                color: var(--favorite-color);
            }


        /* Settings layout */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .settings-group {
            margin-bottom: 15px;
        }

            .settings-group label {
                display: block;
                margin-bottom: 5px;
                font-weight: 500;
            }

            .settings-group input,
            .settings-group select {
                width: 100%;
                padding: 8px;
                border-radius: 4px;
                border: 1px solid #ccc;
            }

        /* Responsive Design */
        @media (max-width: 768px) {
            .suggested-songs-drawer {
                width: 45%;
                right: -85%;
            }
            
            .toggle-suggested-songs {
                right: 10px;
                bottom: 180px;
            }
            
            #toggle-sidebar {
                top: 100px;
                left: 10px;
            }

            #toggle-songs {
                top: 150px;
                left: 10px;
            }

            #toggle-all-panels {
                top: 200px;
                left: 10px;
            }

            .sidebar.hidden ~ #toggle-songs {
                left: 15px;
            }

            .sidebar {
                width: 50%;
                max-width: none;
            }

            .songs-section {
                width: 50%;
                max-width: none;
                left: 0;
            }

            .preview-section {
                margin-left: 0;
                width: 100%;
            }
            
            .modal-content {
                width: 90%;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .auto-scroll-controls {
                bottom: 80px;
                right: 10px;
            }
            
            .keep-screen-on {
                bottom: 130px;
                right: 10px;
            }
        }

        .song-count {
            color: var(--sidebar-text-color);
            background: var(--sidebar-item-bg);
            border: 1px solid var(--sidebar-item-hover-bg);
            padding: 10px;
            border-radius: 4px;
            margin-top: 15px;
            text-align: center;
        }

        .theme-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: var(--sidebar-item-hover-bg);
            color: var(--sidebar-text-color);
            border-radius: 4px;
            margin-top: 15px;
            cursor: pointer;
            transition: background 0.3s;
        }

            .theme-toggle:hover {
                background: var(--secondary-color);
            }

            .theme-toggle span {
                margin-left: 8px;
            }
    </style>
</head>
<body>
    <div class="app-container">
        <button class="panel-toggle draggable" id="toggle-sidebar"><i class="fas fa-home"></i></button>
        <button class="panel-toggle draggable" id="toggle-songs"><i class="fas fa-list"></i></button>
        <button class="panel-toggle draggable" id="toggle-all-panels"><i class="fas fa-eye-slash"></i></button>

        <!-- Auto-scroll controls -->
        <div class="auto-scroll-controls">
            <button class="auto-scroll-btn" id="autoScrollUp" title="Scroll Up"><i class="fas fa-arrow-up"></i></button>
            <button class="auto-scroll-btn" id="autoScrollDown" title="Scroll Down"><i class="fas fa-arrow-down"></i></button>
            <button class="auto-scroll-btn" id="toggleAutoScroll" title="Auto Scroll"><i class="fas fa-play"></i></button>
        </div>

        <!-- Keep screen on button -->
        <button class="keep-screen-on" id="keepScreenOnBtn" title="Keep Screen On"><i class="fa fa-sign-language"></i></button>

        <!-- Notification -->
        <div class="notification" id="notification"></div>

        <!-- Sidebar -->
        <div class="sidebar hidden">
            <div class="sidebar-header">
                <h2>Praise & Worship</h2>
            </div>
            <ul class="sidebar-menu">
                <li><a href="#" class="active" id="showAll">All Songs</a></li>
                <li><a href="#" id="showSetlist">Setlist</a></li>
                <li><a href="#" id="showDelete">Delete Songs</a></li>
                <li><a href="#" id="showFavorites">Favorites</a></li>
            </ul>
            <div class="sidebar-footer">
                <div class="sidebar-footer">
                    <div class="song-count">
                        <div>Total Songs: <span id="totalSongs">0</span></div>
                        <div>Praise: <span id="praiseCount">0</span></div>
                        <div>Worship: <span id="worshipCount">0</span></div>
                    </div>

                    <div class="theme-toggle" id="themeToggle">
                        <i class="fas fa-moon"></i>
                        <span>Dark Mode</span>
                    </div>

                    <button class="sidebar-btn" id="downloadHtmlWithSongsBtn">
                        <i class="fas fa-file-export"></i> Download HTML with Songs
                    </button>
                </div>
                <div class="sidebar-folder">
                    <div class="folder-toggle" id="toggleSongTools">
                        <i class="fas fa-folder-open"></i> Song Tools
                        <i class="fas fa-caret-down folder-caret"></i>
                    </div>
                    <div class="folder-content" id="songToolsContent">
                        <button class="sidebar-btn" id="openAddSongModal">
                            <i class="fa fa-plus"></i> Add New Song
                        </button>
                        <button class="sidebar-btn" id="downloadSongsBtn">
                            <i class="fas fa-download"></i> Download Songs
                        </button>
                        <button class="sidebar-btn" id="uploadSongsBtn">
                            <i class="fas fa-upload"></i> Upload Reset Songs
                        </button>
                        <button class="sidebar-btn" id="mergeSongsBtn">
                            <i class="fas fa-compress-arrows-alt"></i> Upload Merge Songs
                        </button>
                        <button class="sidebar-btn btn-delete" id="deleteAllSongsBtn">
                            <i class="fas fa-trash-alt"></i> Delete All Songs
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Songs Panel -->
        <div class="songs-section hidden">
            <div class="sticky-header">
                <div class="tabs">
                    <div class="setlist-tab active" id="praiseTab">Praise</div>
                    <div class="setlist-tab" id="worshipTab">Worship</div>
                </div>
                <div class="filters-row">
                    <div class="search-container">
                        <input type="text" id="searchInput" class="compact-input" placeholder="Search songs..."
                               style="padding-right: 30px;" autocomplete="off">
                        <span id="clearSearch" class="clear-search-btn" style="display: none;">×</span>
                        <div id="searchHistoryDropdown" class="search-history-dropdown"></div>
                    </div>
                    <select id="keyFilter" class="compact-select">
                        <option value="">All Keys</option>
                        <option value="C">C Major</option>
                        <option value="C#">C# Major</option>
                        <option value="D">D Major</option>
                        <option value="D#">D# Major</option>
                        <option value="E">E Major</option>
                        <option value="F">F Major</option>
                        <option value="F#">F# Major</option>
                        <option value="G">G Major</option>
                        <option value="G#">G# Major</option>
                        <option value="A">A Major</option>
                        <option value="A#">A# Major</option>
                        <option value="B">B Major</option>
                        <option value="Cm">Cm</option>
                        <option value="C#m">C#m</option>
                        <option value="Dm">Dm</option>
                        <option value="D#m">D#m</option>
                        <option value="Em">Em</option>
                        <option value="Fm">Fm</option>
                        <option value="F#m">F#m</option>
                        <option value="Gm">Gm</option>
                        <option value="G#m">G#m</option>
                        <option value="Am">Am</option>
                        <option value="A#m">A#m</option>
                        <option value="Bm">Bm</option>
                    </select>
                    <select id="genreFilter" class="compact-select">
                        <option value="">All Genres</option>
                        <option value="Praise">Praise</option>
                        <option value="Worship">Worship</option>
                        <option value="Christmas">Christmas</option>
                        <option value="Easter">Easter</option>
                        <option value="Dance">Dance</option>
                        <option value="Action">Action</option>
                        <option value="Love">Love</option>
                        <option value="Forgiveness">Forgiveness</option>
                        <option value="Holy Spirit">Holy Spirit</option>
                        <option value="Meditative">Meditative</option>
                        <option value="Celebration">Celebration</option>
                    </select>
                </div>

                <div class="search-results" id="searchResults">
                    <div class="search-results-header">Search Results</div>
                    <div id="searchResultsContent" class="scrollable-results"></div>
                </div>
            </div>
            <div class="tab-content active" id="praiseContent"></div>
            <div class="tab-content" id="worshipContent"></div>
            <div class="setlist" id="setlistSection" style="display: none;">
                <h3>Your Setlist</h3>
                <div class="setlist-tabs">
                    <div class="setlist-tab active" id="praiseSetlistTab">Praise</div>
                    <div class="setlist-tab" id="worshipSetlistTab">Worship</div>
                </div>
                <div class="setlist-content">
                    <div id="praiseSetlistSongs"></div>
                    <div id="worshipSetlistSongs" style="display: none;"></div>
                </div>
            </div>
            <div class="delete-section" id="deleteSection" style="display: none;">
                <h3>Delete Songs</h3>
                <div id="deleteContent"></div>
            </div>
            <div class="favorites-section" id="favoritesSection" style="display: none;">
                <h3>Favorite Songs</h3>
                <div id="favoritesContent"></div>
            </div>
        </div>

        <!-- Preview Section -->
        <div class="preview-section" id="songPreview">
            <h2>Select a song</h2>
            <div class="song-lyrics">No song is selected</div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="addSongModal">
        <div class="modal-content">
            <span class="close-modal" aria-label="Close">×</span>
            <h3>Add New Song</h3>
            <form id="newSongForm" class="add-song-form">
                <label for="songTitle">Title:</label>
                <input type="text" id="songTitle" required>
                <label for="songCategory">Category:</label>
                <select id="songCategory" required>
                    <option value="praise">Praise</option>
                    <option value="worship">Worship</option>
                </select>
                <label for="songKey">Key:</label>
                <select id="songKey" required>
                    <option value="C">C Major</option>
                    <option value="C#">C# Major</option>
                    <option value="D">D Major</option>
                    <option value="D#">D# Major</option>
                    <option value="E">E Major</option>
                    <option value="F">F Major</option>
                    <option value="F#">F# Major</option>
                    <option value="G">G Major</option>
                    <option value="G#">G# Major</option>
                    <option value="A">A Major</option>
                    <option value="A#">A# Major</option>
                    <option value="B">B Major</option>
                    <option value="Cm">Cm</option>
                    <option value="C#m">C#m</option>
                    <option value="Dm">Dm</option>
                    <option value="D#m">D#m</option>
                    <option value="Em">Em</option>
                    <option value="Fm">Fm</option>
                    <option value="F#m">F#m</option>
                    <option value="Gm">Gm</option>
                    <option value="G#m">G#m</option>
                    <option value="Am">Am</option>
                    <option value="A#m">A#m</option>
                    <option value="Bm">Bm</option>
                </select>
                <label for="songTempo">Tempo (BPM):</label>
                <input type="text" id="songTempo" placeholder="e.g., 80 BPM" required>
                <label for="songTime">Time Signature:</label>
                <select id="songTime" required>
                    <option value="4/4">4/4</option>
                    <option value="3/4">3/4</option>
                    <option value="2/4">2/4</option>
                    <option value="6/8">6/8</option>
                    <option value="5/4">5/4</option>
                    <option value="7/8">7/8</option>
                </select>
                <label for="songTaal">Taal:</label>
                <select id="songTaal" required>
                    <option value="Dadra">Dadra</option>
                    <option value="Keherwa">Keherwa</option>
                    <option value="Rupak">Rupak</option>
                    <option value="EkTaal">EkTaal</option>
                    <option value="JhapTaal">JhapTaal</option>
                    <option value="TeenTaal">TeenTaal</option>
                </select>
                <label for="songGenre">Genre:</label>
                <div class="multiselect-container">
                    <input type="text" id="songGenre" class="compact-input" placeholder="Select genres..." readonly>
                    <div class="multiselect-dropdown" id="genreDropdown">
                        <div class="multiselect-option" data-value="Praise">Praise</div>
                        <div class="multiselect-option" data-value="Worship">Worship</div>
                        <div class="multiselect-option" data-value="Christmas">Christmas</div>
                        <div class="multiselect-option" data-value="Easter">Easter</div>
                        <div class="multiselect-option" data-value="Dance">Dance</div>
                        <div class="multiselect-option" data-value="Action">Action</div>
                        <div class="multiselect-option" data-value="Love">Love</div>
                        <div class="multiselect-option" data-value="Forgiveness">Forgiveness</div>
                        <div class="multiselect-option" data-value="Holy Spirit">Holy Spirit</div>
                        <div class="multiselect-option" data-value="Meditative">Meditative</div>
                        <div class="multiselect-option" data-value="Celebration">Celebration</div>
                    </div>
                    <div class="multiselect-selected" id="selectedGenres"></div>
                </div>
                <label for="songLyrics">Lyrics:</label>
                <textarea id="songLyrics" required></textarea>
                <button type="submit" class="btn btn-primary">Add Song</button>
            </form>
        </div>
    </div>

    <div class="modal" id="editSongModal">
        <div class="modal-content">
            <span class="close-modal" aria-label="Close">×</span>
            <h3>Edit Song</h3>
            <form id="editSongForm" class="edit-song-form">
                <input type="hidden" id="editSongId">
                <label for="editSongTitle">Title:</label>
                <input type="text" id="editSongTitle" required>
                <label for="editSongCategory">Category:</label>
                <select id="editSongCategory" required>
                    <option value="praise">Praise</option>
                    <option value="worship">Worship</option>
                </select>
                <label for="editSongKey">Key:</label>
                <select id="editSongKey" required>
                    <option value="C">C Major</option>
                    <option value="C#">C# Major</option>
                    <option value="D">D Major</option>
                    <option value="D#">D# Major</option>
                    <option value="E">E Major</option>
                    <option value="F">F Major</option>
                    <option value="F#">F# Major</option>
                    <option value="G">G Major</option>
                    <option value="G#">G# Major</option>
                    <option value="A">A Major</option>
                    <option value="A#">A# Major</option>
                    <option value="B">B Major</option>
                    <option value="Cm">Cm</option>
                    <option value="C#m">C#m</option>
                    <option value="Dm">Dm</option>
                    <option value="D#m">D#m</option>
                    <option value="Em">Em</option>
                    <option value="Fm">Fm</option>
                    <option value="F#m">F#m</option>
                    <option value="Gm">Gm</option>
                    <option value="G#m">G#m</option>
                    <option value="Am">Am</option>
                    <option value="A#m">A#m</option>
                    <option value="Bm">Bm</option>
                </select>
                <label for="editSongTempo">Tempo (BPM):</label>
                <input type="text" id="editSongTempo" placeholder="e.g., 80 BPM" required>
                <label for="editSongTime">Time Signature:</label>
                <select id="editSongTime" required>
                    <option value="4/4">4/4</option>
                    <option value="3/4">3/4</option>
                    <option value="2/4">2/4</option>
                    <option value="6/8">6/8</option>
                    <option value="5/4">5/4</option>
                    <option value="7/8">7/8</option>
                </select>
                <label for="editSongTaal">Taal:</label>
                <select id="editSongTaal" required>
                    <option value="Dadra">Dadra</option>
                    <option value="Keherwa">Keherwa</option>
                    <option value="Rupak">Rupak</option>
                    <option value="EkTaal">EkTaal</option>
                    <option value="JhapTaal">JhapTaal</option>
                    <option value="TeenTaal">TeenTaal</option>
                </select>
                <label for="editSongGenre">Genre:</label>
                <div class="multiselect-container">
                    <input type="text" id="editSongGenre" class="compact-input" placeholder="Select genres..." readonly>
                    <div class="multiselect-dropdown" id="editGenreDropdown">
                        <div class="multiselect-option" data-value="Praise">Praise</div>
                        <div class="multiselect-option" data-value="Worship">Worship</div>
                        <div class="multiselect-option" data-value="Christmas">Christmas</div>
                        <div class="multiselect-option" data-value="Easter">Easter</div>
                        <div class="multiselect-option" data-value="Dance">Dance</div>
                        <div class="multiselect-option" data-value="Action">Action</div>
                        <div class="multiselect-option" data-value="Love">Love</div>
                        <div class="multiselect-option" data-value="Forgiveness">Forgiveness</div>
                        <div class="multiselect-option" data-value="Holy Spirit">Holy Spirit</div>
                        <div class="multiselect-option" data-value="Meditative">Meditative</div>
                        <div class="multiselect-option" data-value="Celebration">Celebration</div>
                    </div>
                    <div class="multiselect-selected" id="editSelectedGenres"></div>
                </div>
                <label for="editSongLyrics">Lyrics:</label>
                <textarea id="editSongLyrics" required></textarea>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </form>
        </div>
    </div>

    <div class="modal" id="deleteSongModal">
        <div class="modal-content">
            <span class="close-modal" aria-label="Close">×</span>
            <h3>Confirm Deletion</h3>
            <form id="deleteSongForm" class="delete-song-form">
                <input type="hidden" id="deleteSongId">
                <p id="deleteSongMessage">Are you sure you want to delete "<span id="deleteSongTitle"></span>"?</p>
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn btn-cancel" id="cancelDeleteSong">Cancel</button>
                    <button type="submit" class="btn btn-delete">Delete</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="confirmDeleteAllModal">
        <div class="modal-content">
            <span class="close-modal" aria-label="Close">×</span>
            <h3>Confirm Delete All Songs</h3>
            <div class="delete-song-form">
                <p>Are you sure you want to delete ALL songs? This cannot be undone.</p>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-cancel" id="cancelDeleteAll">Cancel</button>
                    <button class="btn btn-delete" id="confirmDeleteAll">Delete All</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <span class="close-modal" onclick="$('#settingsModal').hide()">×</span>
            <h3>Settings</h3>
            <form id="settingsForm">
                <div class="settings-grid">
                    <div class="settings-group">
                        <label for="sidebarHeaderInput">Sidebar Header:</label>
                        <input type="text" id="sidebarHeaderInput" required>
                    </div>
                    <div class="settings-group">
                        <label for="setlistTextInput">Setlist Menu Text:</label>
                        <input type="text" id="setlistTextInput" required>
                    </div>
                    <div class="settings-group">
                        <label for="sidebarWidthInput">Sidebar Width (%):</label>
                        <input type="number" id="sidebarWidthInput" min="10" max="100" value="30">
                    </div>
                    <div class="settings-group">
                        <label for="songsPanelWidthInput">Songs Panel Width (%):</label>
                        <input type="number" id="songsPanelWidthInput" min="10" max="100" value="30">
                    </div>
                    <div class="settings-group">
                        <label for="previewMarginInput">Preview Margin Left (px):</label>
                        <input type="number" id="previewMarginInput" min="0" max="100" value="40">
                    </div>
                    <div class="settings-group">
                        <label for="autoScrollSpeedInput">Auto Scroll Speed:</label>
                        <select id="autoScrollSpeedInput">
                            <option value="2000">Slow</option>
                            <option value="1500" selected>Medium</option>
                            <option value="1000">Fast</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Save Settings</button>
            </form>
        </div>
    </div>
    
    <!-- Suggested Songs Drawer -->
    <div class="suggested-songs-drawer" id="suggestedSongsDrawer">
        <div class="suggested-songs-header">
            <h3>Suggested Songs</h3>
            <button class="close-suggested-songs" id="closeSuggestedSongs">&times;</button>
        </div>
        <div id="suggestedSongsContent"></div>
    </div>

    <button class="toggle-suggested-songs" id="toggleSuggestedSongs" title="Suggested Songs">
        <i class="fa fa-random"></i>
    </button>

    <script id="embeddedSongs" type="application/json">
        []
    </script>

    <script>
        $(document).ready(function() {
            // Initialize application
            const app = {
                isDarkMode: localStorage.getItem('darkMode') === 'true',
                socket: null,
                songs: [],
                favorites: JSON.parse(localStorage.getItem('favorites')) || [],
                keepScreenOn: false,
                autoScrollSpeed: localStorage.getItem('autoScrollSpeed') || 1500,
                suggestedSongsDrawerOpen: false,
                praiseSetlist: JSON.parse(localStorage.getItem('praiseSetlist')) || [],
                worshipSetlist: JSON.parse(localStorage.getItem('worshipSetlist')) || [],
                searchHistory: JSON.parse(localStorage.getItem('searchHistory')) || [],
                autoScrollInterval: null,
                isUserScrolling: false,
                CHORDS: ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'],
                CHORD_REGEX: /([A-G](?:#|b)?)(m|maj|min|dim|aug|m7|maj7|7|sus2|sus4)?/gi,
                CHORD_LINE_REGEX: /^(\s*[A-G](?:#|b)?(?:m|maj|min|dim|aug|m7|maj7|7|sus2|sus4)?\s*)+$/i,
                INLINE_CHORD_REGEX: /\[([A-G](?:#|b)?(?:m|maj|min|dim|aug|m7|maj7|7|sus2|sus4)?)\]/gi,
                SLASH_CHORD_REGEX: /([A-G](?:#|b)?)(?:\/([A-G](?:#|b)?))?/gi,

                init: function() {
                    this.loadSongs().then(() => {
                        this.loadSettings();
                        this.setupEventListeners();
                        this.setupPanelToggles();
                        this.renderSongs('praise', '', '');
                        this.applyLyricsBackground($('#praiseTab').hasClass('active'));
                        
                        if (this.isDarkMode) {
                            $('body').addClass('dark-mode');
                            $('#themeToggle').html('<i class="fas fa-sun"></i><span>Light Mode</span>');
                        }
                        this.setupSwipeGestures();
                        this.connectWebSocket();
                        this.updateSongCount();
                        this.initScreenWakeLock();
                    });
                },

                setupSwipeGestures: function() {
                    const previewEl = $('#songPreview')[0];
                    if (!previewEl) return;

                    // Use object properties to maintain state
                    this.swipeState = {
                        touchStartX: 0,
                        touchEndX: 0,
                        swipeThreshold: 50 // Minimum distance to consider it a swipe
                    };

                    const handleTouchStart = (e) => {
                        this.swipeState.touchStartX = e.changedTouches[0].screenX;
                    };

                    const handleTouchEnd = (e) => {
                        this.swipeState.touchEndX = e.changedTouches[0].screenX;
                        this.handleSwipe();
                    };

                    previewEl.addEventListener('touchstart', handleTouchStart, { passive: true });
                    previewEl.addEventListener('touchend', handleTouchEnd, { passive: true });

                    // Store references for later removal if needed
                    this.swipeHandlers = {
                        start: handleTouchStart,
                        end: handleTouchEnd
                    };
                },

                handleSwipe: function() {
                    const diff = this.swipeState.touchEndX - this.swipeState.touchStartX;
                    
                    // Left swipe (next song)
                    if (diff < -this.swipeState.swipeThreshold) {
                        this.showNextSong();
                    } 
                    // Right swipe (previous song)
                    else if (diff > this.swipeState.swipeThreshold) {
                        this.showPreviousSong();
                    }
                },

                showNextSong: function() {
                    if (!$('#songPreview').data('songId')) return;
                    
                    const currentId = $('#songPreview').data('songId');
                    const currentCategory = $('#praiseTab').hasClass('active') ? 'praise' : 'worship';
                    
                    // Get filtered songs based on current view
                    let songs = this.songs
                        .filter(song => song.category === currentCategory)
                        .filter(song => {
                            const keyFilter = $('#keyFilter').val();
                            return keyFilter === "" || song.key === keyFilter;
                        })
                        .filter(song => {
                            const genreFilter = $('#genreFilter').val();
                            if (!genreFilter) return true;
                            if (!song.genres) return song.genre === genreFilter;
                            return song.genres.includes(genreFilter);
                        })
                        .sort((a, b) => a.title.localeCompare(b.title));
                    
                    // If in search results, use those songs instead
                    if ($('#searchResults').hasClass('active')) {
                        songs = $('#searchResultsContent .search-result-item')
                            .map((i, el) => {
                                const id = parseInt($(el).data('songId'));
                                return this.songs.find(s => s.id === id);
                            }).get();
                    }
                    // If in favorites, use favorite songs
                    else if ($('#favoritesSection').css('display') === 'block') {
                        songs = this.favorites.map(id => this.songs.find(s => s.id === id));
                    }
                    // If in setlist, use setlist songs
                    else if ($('#setlistSection').css('display') === 'block') {
                        songs = $('#praiseSetlistTab').hasClass('active') 
                            ? this.praiseSetlist 
                            : this.worshipSetlist;
                    }
                    
                    const currentIndex = songs.findIndex(s => s.id === currentId);
                    if (currentIndex === -1) return;
                    
                    const nextIndex = (currentIndex + 1) % songs.length;
                    this.showPreview(songs[nextIndex]);
                },

                showPreviousSong: function() {
                    if (!$('#songPreview').data('songId')) return;
                    
                    const currentId = $('#songPreview').data('songId');
                    const currentCategory = $('#praiseTab').hasClass('active') ? 'praise' : 'worship';
                    
                    // Get filtered songs based on current view
                    let songs = this.songs
                        .filter(song => song.category === currentCategory)
                        .filter(song => {
                            const keyFilter = $('#keyFilter').val();
                            return keyFilter === "" || song.key === keyFilter;
                        })
                        .filter(song => {
                            const genreFilter = $('#genreFilter').val();
                            if (!genreFilter) return true;
                            if (!song.genres) return song.genre === genreFilter;
                            return song.genres.includes(genreFilter);
                        })
                        .sort((a, b) => a.title.localeCompare(b.title));
                    
                    // If in search results, use those songs instead
                    if ($('#searchResults').hasClass('active')) {
                        songs = $('#searchResultsContent .search-result-item')
                            .map((i, el) => {
                                const id = parseInt($(el).data('songId'));
                                return this.songs.find(s => s.id === id);
                            }).get();
                    }
                    // If in favorites, use favorite songs
                    else if ($('#favoritesSection').css('display') === 'block') {
                        songs = this.favorites.map(id => this.songs.find(s => s.id === id));
                    }
                    // If in setlist, use setlist songs
                    else if ($('#setlistSection').css('display') === 'block') {
                        songs = $('#praiseSetlistTab').hasClass('active') 
                            ? this.praiseSetlist 
                            : this.worshipSetlist;
                    }
                    
                    const currentIndex = songs.findIndex(s => s.id === currentId);
                    if (currentIndex === -1) return;
                    
                    const prevIndex = (currentIndex - 1 + songs.length) % songs.length;
                    this.showPreview(songs[prevIndex]);
                },


                loadSongs: async function() {
                    try {
                        // Try multiple possible paths for GitHub Pages compatibility
                        const pathsToTry = [
                            './songs.json',
                            '/songs.json',
                            'songs.json',
                            `${window.location.pathname.split('/')[1]}/songs.json`
                        ];

                        let loaded = false;
                        
                        for (const path of pathsToTry) {
                            try {
                                const response = await $.ajax({
                                    url: path,
                                    dataType: 'json'
                                });
                                
                                if (Array.isArray(response)) {
                                    this.songs = response;
                                    loaded = true;
                                    break;
                                } else if (Array.isArray(response.songs)) {
                                    this.songs = response.songs;
                                    loaded = true;
                                    break;
                                }
                            } catch (e) {
                                console.log(`Failed to load from ${path}`, e);
                            }
                        }
                        
                        if (!loaded) {
                            // Fallback to embedded songs if available
                            const embedded = $('#embeddedSongs').text().trim();
                            if (embedded !== '[]') {
                                const embeddedData = JSON.parse(embedded);
                                this.songs = Array.isArray(embeddedData) ? embeddedData : [];
                            }
                        }
                        
                        // Load any songs from localStorage that might have been added
                        const localSongs = JSON.parse(localStorage.getItem('songs')) || [];
                        if (localSongs.length > 0) {
                            const existingIds = new Set(this.songs.map(s => s.id));
                            localSongs.forEach(song => {
                                if (!existingIds.has(song.id)) {
                                    this.songs.push(song);
                                }
                            });
                        }
                    } catch (err) {
                        console.error('Error loading songs:', err);
                    }
                },

                connectWebSocket: function() {
                    // WebSocket removed for GitHub Pages compatibility
                    console.log("WebSocket connection removed for GitHub Pages compatibility");
                },

                updateSongCount: function() {
                    $('#totalSongs').text(this.songs.length);
                    $('#praiseCount').text(this.songs.filter(s => s.category === 'praise').length);
                    $('#worshipCount').text(this.songs.filter(s => s.category === 'worship').length);
                },

                initScreenWakeLock: function() {
                    if ('wakeLock' in navigator) {
                        $('#keepScreenOnBtn').show();
                    } else {
                        $('#keepScreenOnBtn').hide();
                    }
                },

                toggleScreenWakeLock: async function() {
                    if (!('wakeLock' in navigator)) return;
                    
                    if (!this.keepScreenOn) {
                        try {
                            const wakeLock = await navigator.wakeLock.request('screen');
                            this.keepScreenOn = true;
                            $('#keepScreenOnBtn').addClass('active');
                            this.showNotification('Screen will stay on');
                        } catch (err) {
                            console.error('Error enabling wake lock:', err);
                            this.showNotification('Failed to keep screen on');
                        }
                    } else {
                        this.keepScreenOn = false;
                        $('#keepScreenOnBtn').removeClass('active');
                        this.showNotification('Screen may sleep');
                    }
                },

                showNotification: function(message, duration = 3000) {
                    $('#notification').text(message).addClass('show');
                    setTimeout(() => $('#notification').removeClass('show'), duration);
                },

                loadSettings: function() {
                    const savedHeader = localStorage.getItem("sidebarHeader");
                    if (savedHeader) $(".sidebar-header h2").text(savedHeader);

                    const savedSetlistLabel = localStorage.getItem("setlistText");
                    if (savedSetlistLabel) $("#showSetlist").text(savedSetlistLabel);

                    const sidebarWidth = localStorage.getItem("sidebarWidth") || "15";
                    const songsPanelWidth = localStorage.getItem("songsPanelWidth") || "20";
                    const previewMargin = localStorage.getItem("previewMargin") || "40";
                    const savedAutoScrollSpeed = localStorage.getItem("autoScrollSpeed") || "1500";

                    $(':root').css({
                        '--sidebar-width': `${sidebarWidth}%`,
                        '--songs-panel-width': `${songsPanelWidth}%`,
                        '--preview-margin-left': `${previewMargin}px`
                    });

                    $('#sidebarWidthInput').val(sidebarWidth);
                    $('#songsPanelWidthInput').val(songsPanelWidth);
                    $('#previewMarginInput').val(previewMargin);
                    $('#autoScrollSpeedInput').val(savedAutoScrollSpeed);
                    
                    this.autoScrollSpeed = parseInt(savedAutoScrollSpeed);
                },

                saveSettings: function() {
                    const newHeader = $("#sidebarHeaderInput").val();
                    const newSetlist = $("#setlistTextInput").val();
                    const sidebarWidth = $("#sidebarWidthInput").val();
                    const songsPanelWidth = $("#songsPanelWidthInput").val();
                    const previewMargin = $("#previewMarginInput").val();
                    const newAutoScrollSpeed = $("#autoScrollSpeedInput").val();

                    $(".sidebar-header h2").text(newHeader);
                    $("#showSetlist").text(newSetlist);

                    $(':root').css({
                        '--sidebar-width': `${sidebarWidth}%`,
                        '--songs-panel-width': `${songsPanelWidth}%`,
                        '--preview-margin-left': `${previewMargin}px`
                    });

                    localStorage.setItem("sidebarHeader", newHeader);
                    localStorage.setItem("setlistText", newSetlist);
                    localStorage.setItem("sidebarWidth", sidebarWidth);
                    localStorage.setItem("songsPanelWidth", songsPanelWidth);
                    localStorage.setItem("previewMargin", previewMargin);
                    localStorage.setItem("autoScrollSpeed", newAutoScrollSpeed);
                    
                    this.autoScrollSpeed = parseInt(newAutoScrollSpeed);
                    this.updatePositions();
                },

                applyLyricsBackground: function(isPraise) {
                    const lyricsContainer = $(".song-lyrics");
                    if (!lyricsContainer.length) return;
                    lyricsContainer.removeClass("lyrics-bg-praise lyrics-bg-worship")
                                 .addClass(isPraise ? "lyrics-bg-praise" : "lyrics-bg-worship");
                },

                setupPanelToggles: function() {
                    const sidebar = $('.sidebar');
                    const songsSection = $('.songs-section');
                    const previewSection = $('.preview-section');
                    const toggleSidebarBtn = $('#toggle-sidebar');
                    const toggleSongsBtn = $('#toggle-songs');
                    const toggleAllPanelsBtn = $('#toggle-all-panels');

                    if (!sidebar.length || !songsSection.length || !previewSection.length || 
                        !toggleSidebarBtn.length || !toggleSongsBtn.length || !toggleAllPanelsBtn.length) {
                        console.error('One or more elements not found for panel toggles');
                        return;
                    }

                    toggleSidebarBtn.on('click', (e) => {
                        e.stopPropagation();
                        sidebar.toggleClass('hidden');
                        if ($(window).width() <= 768) {
                            songsSection.addClass('hidden');
                        }
                        this.updatePositions();
                    });

                    toggleSongsBtn.on('click', (e) => {
                        e.stopPropagation();
                        songsSection.toggleClass('hidden');
                        if ($(window).width() <= 768) {
                            sidebar.addClass('hidden');
                        }
                        this.updatePositions();
                    });

                    toggleAllPanelsBtn.on('click', (e) => {
                        e.stopPropagation();
                        const areBothHidden = sidebar.hasClass('hidden') && songsSection.hasClass('hidden');
                        sidebar.toggleClass('hidden', !areBothHidden);
                        songsSection.toggleClass('hidden', !areBothHidden);
                        toggleAllPanelsBtn.find('i').attr('class', areBothHidden ? 'fas fa-eye-slash' : 'fas fa-eye');
                        this.updatePositions();
                    });

                    $(document).on('click', (e) => {
                        if ($(window).width() <= 768 &&
                            !$(e.target).closest('.sidebar').length &&
                            !$(e.target).closest('.songs-section').length &&
                            !$(e.target).closest('.panel-toggle').length &&
                            !$(e.target).closest('.modal').length) {
                            sidebar.addClass('hidden');
                            songsSection.addClass('hidden');
                            toggleAllPanelsBtn.find('i').attr('class', 'fas fa-eye');
                            this.updatePositions();
                        }
                    });

                    if ($(window).width() > 768) {
                        sidebar.removeClass('hidden');
                        songsSection.removeClass('hidden');
                    } else {
                        sidebar.addClass('hidden');
                        songsSection.addClass('hidden');
                    }
                    this.updatePositions();

                    $(window).on('resize', () => this.updatePositions());
                },

                updatePositions: function() {
                if ($(window).width() > 768) {
                    const sidebarHidden = $('.sidebar').hasClass('hidden');
                    const songsHidden = $('.songs-section').hasClass('hidden');
                    
                    if (sidebarHidden && songsHidden) {
                        $('.preview-section').css({
                            'margin-left': 'var(--preview-margin-left)',
                            'width': 'calc(100% - var(--preview-margin-left) - 20px)'
                        });
                    } else if (sidebarHidden) {
                        $('.songs-section').css('left', '0');
                        $('.preview-section').css({
                            'margin-left': 'calc(var(--songs-panel-width) + var(--preview-margin-left))',
                            'width': 'calc(100% - var(--songs-panel-width) - var(--preview-margin-left) - 20px)'
                        });
                    } else if (songsHidden) {
                        $('.preview-section').css({
                            'margin-left': 'calc(var(--sidebar-width) + var(--preview-margin-left))',
                            'width': 'calc(100% - var(--sidebar-width) - var(--preview-margin-left) - 20px)'
                        });
                    } else {
                        $('.preview-section').css({
                            'margin-left': 'calc(var(--sidebar-width) + var(--songs-panel-width) + var(--preview-margin-left))',
                            'width': 'calc(100% - var(--sidebar-width) - var(--songs-panel-width) - var(--preview-margin-left) - 20px)'
                        });
                    }
                } else {
                    $('.preview-section').css({
                        'margin-left': '0',
                        'width': '100%'
                    }).addClass('full-width');
                }
            },

                saveSongs: function(toFile = false) {
                    if (toFile) {
                        try {
                            const data = {
                                songs: this.songs,
                                praiseSetlist: this.praiseSetlist,
                                worshipSetlist: this.worshipSetlist
                            };
                            console.warn('File saving requires server-side support');
                        } catch (err) {
                            console.error('Error saving to file:', err);
                        }
                        
                        if (this.socket && this.socket.readyState === WebSocket.OPEN) {
                            this.socket.send(JSON.stringify({
                                type: 'update',
                                songs: this.songs,
                                praiseSetlist: this.praiseSetlist,
                                worshipSetlist: this.worshipSetlist
                            }));
                        }
                    }

                    localStorage.setItem('songs', JSON.stringify(this.songs));
                    const embedded = $('#embeddedSongs');
                    if (embedded.length) {
                        embedded.text(JSON.stringify(this.songs, null, 2));
                    }
                },

                saveSetlists: function() {
                    localStorage.setItem('praiseSetlist', JSON.stringify(this.praiseSetlist));
                    localStorage.setItem('worshipSetlist', JSON.stringify(this.worshipSetlist));
                    if (this.socket && this.socket.readyState === WebSocket.OPEN) {
                        this.socket.send(JSON.stringify({
                            type: 'update',
                            songs: this.songs,
                            praiseSetlist: this.praiseSetlist,
                            worshipSetlist: this.worshipSetlist
                        }));
                    }
                },

                saveFavorites: function() {
                    localStorage.setItem('favorites', JSON.stringify(this.favorites));
                },

                downloadSongs: function() {
                    const data = {
                        songs: this.songs,
                        praiseSetlist: this.praiseSetlist,
                        worshipSetlist: this.worshipSetlist,
                        favorites: this.favorites
                    };
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'worship-songs.json';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                },

                handleFileUpload: function(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.songs && Array.isArray(data.songs)) {
                                this.songs = data.songs;
                                this.praiseSetlist = data.praiseSetlist || [];
                                this.worshipSetlist = data.worshipSetlist || [];
                                this.favorites = data.favorites || [];
                                this.saveSongs();
                                this.saveSetlists();
                                this.saveFavorites();
                                if ($('#praiseTab').hasClass('active')) {
                                    this.renderSongs('praise', $('#keyFilter').val(), $('#genreFilter').val());
                                } else {
                                    this.renderSongs('worship', $('#keyFilter').val(), $('#genreFilter').val());
                                }
                                this.showNotification('Songs loaded successfully!');
                            } else {
                                throw new Error('Invalid file format');
                            }
                        } catch (err) {
                            this.showNotification('Could not load file: ' + err.message);
                        }
                    };
                    reader.onerror = () => this.showNotification('Error reading file');
                    reader.readAsText(file);
                },

                handleMergeUpload: function(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.songs && Array.isArray(data.songs)) {
                                const existingIds = new Set(this.songs.map(s => s.id));
                                const newSongs = data.songs.filter(song => !existingIds.has(song.id));
                                const nextId = Math.max(0, ...this.songs.map(s => s.id)) + 1;

                                newSongs.forEach((song, index) => {
                                    song.id = nextId + index;
                                });

                                this.songs = [...this.songs, ...newSongs];
                                this.saveSongs();

                                this.showNotification(`${newSongs.length} new songs merged successfully.`);
                                if ($('#praiseTab').hasClass('active')) {
                                    this.renderSongs('praise', $('#keyFilter').val(), $('#genreFilter').val());
                                } else {
                                    this.renderSongs('worship', $('#keyFilter').val(), $('#genreFilter').val());
                                }
                            } else {
                                throw new Error('Invalid file format');
                            }
                        } catch (err) {
                            this.showNotification('Could not merge file: ' + err.message);
                        }
                    };
                    reader.readAsText(file);
                },

                isDuplicateSong: function(title, lyrics, currentId = null) {
                    return this.songs.some(song => {
                        if (currentId && song.id === currentId) return false;
                        return song.title.toLowerCase() === title.toLowerCase() && 
                               song.lyrics.toLowerCase() === lyrics.toLowerCase();
                    });
                },

                saveSearchQuery: function(query) {
                    if (!query.trim()) return;

                    this.searchHistory = this.searchHistory.filter(item => 
                        item.toLowerCase() !== query.toLowerCase());
                    this.searchHistory.unshift(query);

                    if (this.searchHistory.length > 10) {
                        this.searchHistory = this.searchHistory.slice(0, 10);
                    }

                    localStorage.setItem('searchHistory', JSON.stringify(this.searchHistory));
                },

                showSearchHistory: function() {
                    const dropdown = $('#searchHistoryDropdown');
                    dropdown.empty();

                    if (this.searchHistory.length === 0) {
                        dropdown.hide();
                        return;
                    }

                    dropdown.append($('<div class="search-history-header">Recent Searches</div>'));

                    this.searchHistory.forEach(query => {
                        const item = $('<div class="search-history-item">').text(query);
                        item.on('click', () => {
                            $('#searchInput').val(query);
                            dropdown.hide();
                            $('#searchInput').trigger('input');
                        });
                        dropdown.append(item);
                    });

                    dropdown.show();
                },

                highlightText: function(text, query) {
                    if (!query) return text;
                    const regex = new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                    return text.replace(regex, match => `<span class="highlight">${match}</span>`);
                },

                renderSongs: function(categoryOrSongs, filterOrContainer, genreFilterValue) {
                    let songsToRender;
                    let container;
                    
                    if (typeof categoryOrSongs === 'string') {
                        const category = categoryOrSongs;
                        const keyFilterValue = filterOrContainer;
                        songsToRender = this.songs
                            .filter(song => song.category === category)
                            .filter(song => keyFilterValue === "" || song.key === keyFilterValue)
                            .filter(song => {
                                if (!genreFilterValue) return true;
                                if (!song.genres) return song.genre === genreFilterValue;
                                return song.genres.includes(genreFilterValue);
                            })
                            .sort((a, b) => a.title.localeCompare(b.title));
                        container = category === 'praise' ? $('#praiseContent') : $('#worshipContent');
                    } else {
                        songsToRender = categoryOrSongs;
                        container = filterOrContainer;
                    }
                    
                    container.empty();
                    
                    if (songsToRender.length === 0) {
                        container.append('<p>No songs found.</p>');
                        return;
                    }
                    
                    songsToRender.forEach(song => {
                        const isInSetlist = song.category === 'praise' 
                            ? this.praiseSetlist.some(s => s.id === song.id)
                            : this.worshipSetlist.some(s => s.id === song.id);
                            
                        const isFavorite = this.favorites.includes(song.id);
                        const displayGenres = song.genres ? song.genres.join(', ') : song.genre || '';
                        
                        const div = $(`
                            <div class="song-item" data-song-id="${song.id}">
                                <button class="favorite-btn ${isFavorite ? 'favorited' : ''}" data-song-id="${song.id}">
                                    <i class="fas fa-heart"></i>
                                </button>
                                <div class="song-title">${song.title}</div>
                                <div class="song-meta">${song.key} | ${song.tempo} | ${song.time} | ${song.taal || ''} | ${displayGenres}</div>
                                <div class="song-actions">
                                    <button class="btn ${isInSetlist ? 'btn-delete' : 'btn-primary'} toggle-setlist">
                                        ${isInSetlist ? 'Remove from Setlist' : 'Add to Setlist'}
                                    </button>
                                    <button class="btn btn-edit edit-song">Edit</button>
                                </div>
                            </div>
                        `);
                        
                        div.find('.favorite-btn').on('click', (e) => {
                            e.stopPropagation();
                            this.toggleFavorite(song.id);
                        });
                        
                        div.find('.toggle-setlist').on('click', (e) => {
                            e.stopPropagation();
                            if (isInSetlist) {
                                this.removeFromSetlist(song.id, song.category);
                            } else {
                                this.addToSetlist(song.id);
                            }
                        });
                        
                        div.find('.edit-song').on('click', (e) => {
                            e.stopPropagation();
                            this.editSong(song.id);
                        });
                        
                        div.on('click', () => {
                            this.showPreview(song);
                            if ($(window).width() <= 768) {
                                $('.songs-section, .sidebar').addClass('hidden');
                                $('.preview-section').addClass('full-width');
                            }
                        });
                        
                        container.append(div);
                    });
                },

                renderFavorites: function() {
                    const favoritesContent = $('#favoritesContent');
                    favoritesContent.empty();
            
                    if (this.favorites.length === 0) {
                        favoritesContent.append('<p>No favorite songs yet.</p>');
                        return;
                    }
            
                    const favoriteSongs = this.songs.filter(song => this.favorites.includes(song.id));
                    this.renderSongs(favoriteSongs, favoritesContent);
                },

                getSuggestedSongs: function() {
                    if (!$('#songPreview').data('songId')) return [];
                    
                    const currentSong = this.songs.find(s => s.id == $('#songPreview').data('songId'));
                    if (!currentSong) return [];
                    
                    // Calculate similarity scores for all other songs
                    const scoredSongs = this.songs
                        .filter(song => song.id !== currentSong.id)
                        .map(song => {
                            let score = 0;
                            
                            // Match on category
                            if (song.category === currentSong.category) score += 20;
                            
                            // Match on key (exact match gets higher score)
                            if (song.key === currentSong.key) score += 15;
                            else if (song.key.replace(/m$/, '') === currentSong.key.replace(/m$/, '')) score += 10;
                            
                            // Match on time signature
                            if (song.time === currentSong.time) score += 10;
                            
                            // Match on taal
                            if (song.taal && currentSong.taal && song.taal === currentSong.taal) score += 10;
                            
                            // Match on genres
                            const currentGenres = currentSong.genres || (currentSong.genre ? [currentSong.genre] : []);
                            const songGenres = song.genres || (song.genre ? [song.genre] : []);
                            const genreMatches = currentGenres.filter(g => songGenres.includes(g)).length;
                            score += genreMatches * 5;
                            
                            return { ...song, score };
                        })
                        .filter(song => song.score > 0) // Only include songs with some match
                        .sort((a, b) => b.score - a.score) // Sort by score descending
                        .slice(0, 5); // Only take top 5
                    
                    return scoredSongs;
                },

                showSuggestedSongs: function() {
                    const suggestedSongs = this.getSuggestedSongs();
                    const content = $('#suggestedSongsContent');
                    
                    if (suggestedSongs.length === 0) {
                        content.html('<p>No suggested songs found based on the current song.</p>');
                        return;
                    }
                    
                    content.empty();
                    
                    suggestedSongs.forEach(song => {
                        const displayGenres = song.genres ? song.genres.join(', ') : song.genre || '';
                        
                        const div = $(`
                            <div class="suggested-song-item" data-song-id="${song.id}">
                                <div class="suggested-song-title">${song.title}</div>
                                <div class="suggested-song-meta">
                                    ${song.key} | ${song.tempo} | ${song.time} | ${song.taal || ''} | ${displayGenres}
                                </div>
                                <span class="suggested-song-match">${song.score}% match</span>
                            </div>
                        `);
                        
                        div.on('click', () => {
                            this.showPreview(song);
                            this.closeSuggestedSongsDrawer();
                        });
                        
                        content.append(div);
                    });
                },

                toggleSuggestedSongsDrawer: function() {
                    const drawer = $('#suggestedSongsDrawer');
                    const toggleBtn = $('#toggleSuggestedSongs');
                    
                    if (this.suggestedSongsDrawerOpen) {
                        drawer.removeClass('open');
                        toggleBtn.css('right', '20px');
                    } else {
                        this.showSuggestedSongs();
                        drawer.addClass('open');
                        toggleBtn.css('right', '370px');
                    }
                    
                    this.suggestedSongsDrawerOpen = !this.suggestedSongsDrawerOpen;
                },

                closeSuggestedSongsDrawer: function() {
                    const drawer = $('#suggestedSongsDrawer');
                    const toggleBtn = $('#toggleSuggestedSongs');
                    
                    drawer.removeClass('open');
                    toggleBtn.css('right', '20px');
                    this.suggestedSongsDrawerOpen = false;
                },

                renderDeleteSongs: function() {
                    const deleteContent = $('#deleteContent');
                    deleteContent.empty();
                    
                    if (this.songs.length === 0) {
                        deleteContent.append('<p>No songs available to delete.</p>');
                        return;
                    }
                    
                    this.songs
                        .sort((a, b) => a.title.localeCompare(b.title))
                        .forEach(song => {
                            const div = $(`
                                <div class="song-item">
                                    <div class="song-title">${song.title}</div>
                                    <div class="song-meta">${song.key} | ${song.tempo} | ${song.time} | ${song.genre} | ${song.category}</div>
                                    <div class="song-actions">
                                        <button class="btn btn-delete delete-song">Delete</button>
                                    </div>
                                </div>
                            `);
                            
                            div.find('.delete-song').on('click', (e) => {
                                e.stopPropagation();
                                this.openDeleteSongModal(song.id);
                            });
                            
                            div.on('click', () => this.showPreview(song));
                            
                            deleteContent.append(div);
                        });
                },

                renderSetlist: function(category) {
                    const container = category === 'praise' ? $('#praiseSetlistSongs') : $('#worshipSetlistSongs');
                    const setlist = category === 'praise' ? this.praiseSetlist : this.worshipSetlist;
                    container.empty();
                    
                    if (setlist.length === 0) {
                        container.append('<p>Your ' + category + ' setlist is empty.</p>');
                        return;
                    }

                    const ul = $('<ul class="setlist-sortable">').css({
                        listStyle: 'none',
                        padding: '0'
                    });

                    setlist.forEach((song, index) => {
                        const li = $('<li>').css({
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            padding: '10px',
                            marginBottom: '8px',
                            background: '#f5f7fa',
                            borderRadius: '5px'
                        }).attr({
                            draggable: 'true',
                            'data-song-id': song.id
                        }).html(`
                            <span><span class="setlist-index">${index + 1}.</span> ${song.title} (${song.key} | ${song.genre})</span>
                            <div class="song-actions">
                                <button class="btn btn-delete">Remove</button>
                            </div>
                        `);

                        li.find('button').on('click', (e) => {
                            e.stopPropagation();
                            this.removeFromSetlist(song.id, song.category);
                        });

                        li.on('click', (e) => {
                            if (!$(e.target).hasClass('btn')) {
                                this.showPreview(song);
                            }
                        });

                        ul.append(li);
                    });

                    container.append(ul);
                    this.enableDrag(container, category);
                },

                enableDrag: function(container, category) {
                    container.find("li").draggable({
                        helper: 'clone',
                        revert: 'invalid',
                        start: function() {
                            $(this).css('display', 'none');
                        },
                        stop: function() {
                            $(this).css('display', 'flex');
                            app.updateSetlistOrder(container, category);
                        }
                    }).droppable({
                        accept: "li",
                        drop: function(event, ui) {
                            const dropped = $(ui.draggable);
                            const target = $(this);
                            
                            if (dropped.index() < target.index()) {
                                dropped.insertAfter(target);
                            } else {
                                dropped.insertBefore(target);
                            }
                        }
                    });
                },

                updateSetlistOrder: function(container, category) {
                    const ids = container.find("li").map((i, li) => parseInt($(li).data('songId'))).get();
                    const fullList = category === 'praise' ? this.praiseSetlist : this.worshipSetlist;
                    const newList = ids.map(id => fullList.find(song => song.id === id));

                    if (category === 'praise') {
                        this.praiseSetlist = newList;
                    } else {
                        this.worshipSetlist = newList;
                    }

                    this.saveSetlists();
                    this.renderSetlist(category);
                },

                showPreview: function(song) {
                    $('#songPreview').data({
                        songId: song.id,
                        originalLyrics: song.lyrics,
                        originalKey: song.key
                    });

                    // Use the raw lyrics without any cleaning that might affect spacing
                    const displayLyrics = song.lyrics;
                    const isFavorite = this.favorites.includes(song.id);

                    $('#songPreview').html(`
                        <h2>${song.title}</h2>
                        <button class="favorite-btn ${isFavorite ? 'favorited' : ''}" id="previewFavoriteBtn" data-song-id="${song.id}">
                            <i class="fas fa-heart"></i>
                        </button>
                        <div class="song-meta">
                            <p><strong>Key:</strong> <span id="current-key">${song.key}</span></p>
                            <p><strong>Tempo:</strong> ${song.tempo}</p>
                            <p><strong>Time Signature:</strong> ${song.time}</p>
                            ${song.taal ? `<p><strong>Taal:</strong> ${song.taal}</p>` : ''}
                            ${song.genres ? `<p><strong>Genres:</strong> ${song.genres.join(', ')}</p>` : 
                             song.genre ? `<p><strong>Genre:</strong> ${song.genre}</p>` : ''}
                        </div>
                        <div class="transpose-controls">
                            <button class="btn btn-primary" id="transpose-down">-</button>
                            <span>Transpose: <span id="transpose-level">0</span></span>
                            <button class="btn btn-primary" id="transpose-up">+</button>
                        </div>
                        <div class="song-lyrics">${this.formatLyricsWithChords(displayLyrics, 0)}</div>
                    `);
                    
                    $('#previewFavoriteBtn').on('click', () => this.toggleFavorite(song.id));
                    $('#transpose-up').on('click', () => {
                        const currentLevel = parseInt($('#transpose-level').text());
                        this.updatePreviewWithTransposition(currentLevel + 1);
                    });
                    $('#transpose-down').on('click', () => {
                        const currentLevel = parseInt($('#transpose-level').text());
                        this.updatePreviewWithTransposition(currentLevel - 1);
                    });
                    
                    this.setupAutoScroll();
                    this.applyLyricsBackground(song.category === 'praise');
                    
                    if (this.suggestedSongsDrawerOpen) {
                        this.showSuggestedSongs();
                    }
                },

                cleanUpLyrics: function(lyrics) {
                    return lyrics.replace(/\n{3,}/g, '\n\n');
                },

                formatLyricsWithChords: function(lyrics, transposeLevel) {
                    const lines = lyrics.split('\n');
                    let output = [];

                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i];

                        if (line.trim() === '') {
                            output.push(`<div class="lyric-line">${line}</div>`);
                            continue;
                        }

                        if (this.isChordLine(line)) {
                            // For chord lines, preserve ALL whitespace exactly
                            let processedLine = line.replace(
                                /([A-G][#b]?(?:m|maj|min|dim|aug|m7|maj7|7|sus2|sus4)?(?:\/[A-G][#b]?)?)/gi,
                                (chord) => {
                                    if (!chord.trim()) return chord; // Return spaces unchanged
                                    
                                    // Handle slash chords
                                    if (chord.includes('/')) {
                                        const [baseChord, bassNote] = chord.split('/');
                                        const transposedBase = this.transposeChord(baseChord.trim(), transposeLevel);
                                        const transposedBass = bassNote ? this.transposeChord(bassNote.trim(), transposeLevel) : '';
                                        return transposedBase + (transposedBass ? '/' + transposedBass : '');
                                    }
                                    
                                    return `<span class="chord" data-original="${chord.trim()}">${this.transposeChord(chord.trim(), transposeLevel)}</span>`;
                                }
                            );
                            output.push(`<div class="chord-line">${processedLine}</div>`);
                        }
                        else if (this.hasInlineChords(line)) {
                            // For lines with inline chords
                            let processedLine = line.replace(
                                /\[([A-G][#b]?(?:m|maj|min|dim|aug|m7|maj7|7|sus2|sus4)?(?:\/[A-G][#b]?)?)\]/gi,
                                (match, chord) => {
                                    // Handle slash chords in inline notation
                                    if (chord.includes('/')) {
                                        const [baseChord, bassNote] = chord.split('/');
                                        const transposedBase = this.transposeChord(baseChord, transposeLevel);
                                        const transposedBass = bassNote ? this.transposeChord(bassNote, transposeLevel) : '';
                                        return `[<span class="chord" data-original="${chord}">${transposedBase}${transposedBass ? '/' + transposedBass : ''}</span>]`;
                                    }
                                    return `[<span class="chord" data-original="${chord}">${this.transposeChord(chord, transposeLevel)}</span>]`;
                                }
                            );
                            output.push(`<div class="lyric-line">${processedLine}</div>`);
                        }
                        else {
                            // Regular lyric line - preserve exactly as is
                            output.push(`<div class="lyric-line">${line}</div>`);
                        }
                    }

                    return output.join('');
                },

                isChordLine: function(line) {
                    return /^(\s*[A-G][#b]?(?:m|maj|min|dim|aug|m7|maj7|7|sus2|sus4)?(?:\/[A-G][#b]?)?\s*)+$/i.test(line.trim());
                },

                hasInlineChords: function(line) {
                    return /\[([A-G][#b]?(?:m|maj|min|dim|aug|m7|maj7|7|sus2|sus4)?(?:\/[A-G][#b]?)?)\]/i.test(line);
                },

                transposeChord: function(chord, steps) {
                    if (steps === 0 || !chord) return chord;

                    // Handle slash chords separately
                    if (chord.includes('/')) {
                        const [baseChord, bassNote] = chord.split('/');
                        const transposedBase = this.transposeSingleChord(baseChord, steps);
                        const transposedBass = bassNote ? this.transposeSingleChord(bassNote, steps) : '';
                        return transposedBase + (transposedBass ? '/' + transposedBass : '');
                    }

                    return this.transposeSingleChord(chord, steps);
                },

                transposeSingleChord: function(chord, steps) {
                    if (steps === 0 || !chord) return chord;

                    const match = chord.match(/^([A-G][#b]?)(.*)$/i);
                    if (!match) return chord;

                    const baseNote = match[1];
                    const quality = match[2] || '';

                    // Normalize to sharps for easier transposition
                    const normalizedNote = baseNote.replace('b', '#').toUpperCase();
                    let currentIndex = this.CHORDS.indexOf(normalizedNote);
                    if (currentIndex === -1) {
                        // Handle flats that don't have direct sharp equivalents
                        const flatToSharp = { 'Db': 'C#', 'Eb': 'D#', 'Gb': 'F#', 'Ab': 'G#', 'Bb': 'A#' };
                        const sharpNote = flatToSharp[baseNote];
                        if (sharpNote) {
                            currentIndex = this.CHORDS.indexOf(sharpNote);
                        }
                        if (currentIndex === -1) return chord;
                    }

                    const newIndex = (currentIndex + steps + this.CHORDS.length) % this.CHORDS.length;
                    let newBaseNote = this.CHORDS[newIndex];

                    // Convert back to flat if that's what was originally used
                    const preferFlat = ['F', 'Bb', 'Eb', 'Ab', 'Db'];
                    if (preferFlat.includes(newBaseNote)) {
                        const sharpToFlat = { 'C#': 'Db', 'D#': 'Eb', 'F#': 'Gb', 'G#': 'Ab', 'A#': 'Bb' };
                        newBaseNote = sharpToFlat[newBaseNote] || newBaseNote;
                    } else if (baseNote === baseNote.toLowerCase()) {
                        newBaseNote = newBaseNote.toLowerCase();
                    }

                    return newBaseNote + quality;
                },

                updatePreviewWithTransposition: function(level) {
                    if (!$('#songPreview').data('songId')) return;

                    const lyrics = $('#songPreview').data('originalLyrics');
                    $('#transpose-level').text(level);
                    const originalKey = $('#songPreview').data('originalKey');
                    $('#current-key').text(level === 0 ? originalKey : this.transposeChord(originalKey, level));

                    const lyricsContainer = $('.song-lyrics');
                    if (lyricsContainer.length) {
                        lyricsContainer.html(this.formatLyricsWithChords(lyrics, level));
                    }
                },

                setupAutoScroll: function() {
                    this.isUserScrolling = false;
                    $('#songPreview').scrollTop(0);
                    if (this.autoScrollInterval) {
                        clearInterval(this.autoScrollInterval);
                        this.autoScrollInterval = null;
                    }
                    
                    // Update button state
                    if ($('#toggleAutoScroll').length) {
                        $('#toggleAutoScroll').html('<i class="fas fa-play"></i>').removeClass('active');
                    }
                },

                startAutoScroll: function(direction = 'down') {
                    if (this.autoScrollInterval) {
                        clearInterval(this.autoScrollInterval);
                    }
                    
                    const scrollStep = direction === 'down' ? 20 : -20;
                    $('#toggleAutoScroll').html('<i class="fas fa-pause"></i>').addClass('active');
                    
                    this.autoScrollInterval = setInterval(() => {
                        if (this.isUserScrolling) return;
                        const previewHeight = $('#songPreview')[0].scrollHeight;
                        const viewportHeight = $('#songPreview')[0].clientHeight;
                        const maxScroll = previewHeight - viewportHeight;
                        const currentScroll = $('#songPreview').scrollTop();
                        
                        if ((direction === 'down' && currentScroll >= maxScroll - 10) || 
                            (direction === 'up' && currentScroll <= 10)) {
                            clearInterval(this.autoScrollInterval);
                            this.autoScrollInterval = null;
                            $('#toggleAutoScroll').html('<i class="fas fa-play"></i>').removeClass('active');
                            return;
                        }
                        
                        const targetScroll = direction === 'down' 
                            ? Math.min(currentScroll + scrollStep, maxScroll)
                            : Math.max(currentScroll + scrollStep, 0);
                            
                        let startTime;
                        const animateScroll = (timestamp) => {
                            if (!startTime) startTime = timestamp;
                            const progress = Math.min((timestamp - startTime) / 300, 1);
                            const ease = progress * (2 - progress);
                            $('#songPreview').scrollTop(currentScroll + (targetScroll - currentScroll) * ease);
                            if (progress < 1 && !this.isUserScrolling) {
                                requestAnimationFrame(animateScroll);
                            }
                        };
                        requestAnimationFrame(animateScroll);
                    }, this.autoScrollSpeed);
                },

                toggleAutoScroll: function() {
                    if (this.autoScrollInterval) {
                        clearInterval(this.autoScrollInterval);
                        this.autoScrollInterval = null;
                        $('#toggleAutoScroll').html('<i class="fas fa-play"></i>').removeClass('active');
                    } else {
                        this.startAutoScroll('down');
                    }
                },

                handleUserScroll: function() {
                    this.isUserScrolling = true;
                    if (this.autoScrollInterval) {
                        clearInterval(this.autoScrollInterval);
                        this.autoScrollInterval = null;
                        $('#toggleAutoScroll').html('<i class="fas fa-play"></i>').removeClass('active');
                    }
                    
                    // Reset the user scrolling flag after a short delay
                    setTimeout(() => {
                        this.isUserScrolling = false;
                    }, 1000);
                },

                addToSetlist: function(id) {
                    const song = this.songs.find(s => s.id === id);
                    if (!song) return;
                    
                    const setlist = song.category === 'praise' ? this.praiseSetlist : this.worshipSetlist;
                    if (!setlist.some(s => s.id === id)) {
                        setlist.push(song);
                        this.saveSetlists();
                        this.showNotification(`"${song.title}" added to ${song.category} setlist`);
                        
                        if ($('#setlistSection').css('display') === 'block' &&
                            (song.category === 'praise' && $('#praiseSetlistTab').hasClass('active') ||
                            song.category === 'worship' && $('#worshipSetlistTab').hasClass('active'))) {
                            this.renderSetlist(song.category);
                        }
                        
                        // Update the song item in the list
                        const songItem = $(`.song-item[data-song-id="${id}"]`);
                        if (songItem.length) {
                            const btn = songItem.find('.toggle-setlist');
                            if (btn.length) {
                                btn.text('Remove from Setlist').removeClass('btn-primary').addClass('btn-delete');
                            }
                        }
                    }
                },

                removeFromSetlist: function(id, category) {
                    const song = this.songs.find(s => s.id === id);
                    if (!song) return;
                    
                    if (category === 'praise') {
                        this.praiseSetlist = this.praiseSetlist.filter(s => s.id !== id);
                    } else {
                        this.worshipSetlist = this.worshipSetlist.filter(s => s.id !== id);
                    }
                    this.saveSetlists();
                    this.showNotification(`"${song.title}" removed from ${category} setlist`);
                    this.renderSetlist(category);
                    
                    // Update the song item in the list
                    const songItem = $(`.song-item[data-song-id="${id}"]`);
                    if (songItem.length) {
                        const btn = songItem.find('.toggle-setlist');
                        if (btn.length) {
                            btn.text('Add to Setlist').removeClass('btn-delete').addClass('btn-primary');
                        }
                    }
                },

                toggleFavorite: function(id) {
                    const index = this.favorites.indexOf(id);
                    const song = this.songs.find(s => s.id === id);
                    
                    if (index === -1) {
                        this.favorites.push(id);
                        this.showNotification(`"${song.title}" added to favorites`);
                    } else {
                        this.favorites.splice(index, 1);
                        this.showNotification(`"${song.title}" removed from favorites`);
                    }
                    
                    this.saveFavorites();
                    
                    // Update favorite buttons
                    $(`.favorite-btn[data-song-id="${id}"]`)
                        .toggleClass('favorited', index === -1)
                        .find('i')
                        .attr('class', index === -1 ? 'fas fa-heart' : 'far fa-heart');
                    
                    // If the song is currently being previewed, update its button
                    if ($('#songPreview').data('songId') == id) {
                        $('#previewFavoriteBtn')
                            .toggleClass('favorited', index === -1)
                            .find('i')
                            .attr('class', index === -1 ? 'fas fa-heart' : 'far fa-heart');
                    }
                },

                redrawPreviewOnThemeChange: function() {
                    if ($('#songPreview').data('songId')) {
                        try {
                            const currentLevel = parseInt($('#transpose-level').text()) || 0;
                            const currentSong = this.songs.find(song => song.id == $('#songPreview').data('songId'));
                            if (currentSong) {
                                this.showPreview(currentSong);
                                this.updatePreviewWithTransposition(currentLevel);
                            }
                        } catch (e) {
                            console.error("Error redrawing preview:", e);
                        }
                    }
                },

                editSong: function(id) {
                    const song = this.songs.find(s => s.id === id);
                    if (!song) return;
                    $('#editSongId').val(song.id);
                    $('#editSongTitle').val(song.title);
                    $('#editSongCategory').val(song.category);
                    $('#editSongKey').val(song.key);
                    $('#editSongTempo').val(song.tempo);
                    $('#editSongTime').val(song.time);
                    $('#editSongTaal').val(song.taal);
                    
                    // Handle genres - support both old single genre and new multi-genre
                    const genres = song.genres || (song.genre ? [song.genre] : []);
                    const editSelectedGenres = $('#editSelectedGenres');
                    editSelectedGenres.empty();
                    
                    genres.forEach(genre => {
                        const tag = $(`
                            <div class="multiselect-tag">
                                ${genre}
                                <span class="remove-tag">×</span>
                            </div>
                        `);
                        editSelectedGenres.append(tag);
                        
                        // Mark the option as selected
                        $(`#editGenreDropdown .multiselect-option[data-value="${genre}"]`).addClass('selected');
                    });
                    
                    $('#editSongLyrics').val(song.lyrics);
                    $('#editSongModal').css('display', 'flex');
                },

                openDeleteSongModal: function(id) {
                    const song = this.songs.find(s => s.id === id);
                    if (!song) return;
                    $('#deleteSongId').val(song.id);
                    $('#deleteSongTitle').text(song.title);
                    $('#deleteSongModal').css('display', 'flex');
                },

                setupEventListeners: function() {
                    // Tab switching
                    $('#praiseTab').on('click', () => {
                        $('#setlistSection, #deleteSection').hide();
                        $('#praiseTab').addClass('active');
                        $('#worshipTab').removeClass('active');
                        $('#praiseContent').addClass('active');
                        $('#worshipContent').removeClass('active');
                        this.renderSongs('praise', $('#keyFilter').val(), $('#genreFilter').val());
                        this.applyLyricsBackground(true);
                    });

                    $('#worshipTab').on('click', () => {
                        $('#setlistSection, #deleteSection').hide();
                        $('#worshipTab').addClass('active');
                        $('#praiseTab').removeClass('active');
                        $('#worshipContent').addClass('active');
                        $('#praiseContent').removeClass('active');
                        this.renderSongs('worship', $('#keyFilter').val(), $('#genreFilter').val());
                        this.applyLyricsBackground(false);
                    });

                    // Theme toggle
                    $('#themeToggle').on('click', () => {
                        this.isDarkMode = !this.isDarkMode;
                        localStorage.setItem('darkMode', this.isDarkMode);
                        $('body').toggleClass('dark-mode');

                        if (this.isDarkMode) {
                            $('#themeToggle').html('<i class="fas fa-sun"></i><span>Light Mode</span>');
                        } else {
                            $('#themeToggle').html('<i class="fas fa-moon"></i><span>Dark Mode</span>');
                        }
                        
                        this.redrawPreviewOnThemeChange();
                    });

                    // Filter changes
                    $('#keyFilter, #genreFilter').on('change', () => {
                        if ($('#praiseTab').hasClass('active')) {
                            this.renderSongs('praise', $('#keyFilter').val(), $('#genreFilter').val());
                        } else {
                            this.renderSongs('worship', $('#keyFilter').val(), $('#genreFilter').val());
                        }
                    });

                    // Menu navigation
                    $('#showSetlist').on('click', (e) => {
                        e.preventDefault();
                        $('.sidebar-menu > li > a').removeClass('active');
                        $(e.currentTarget).addClass('active');
                        $('.songs-section').removeClass('hidden'); // Ensure songs section is visible
                        $('#praiseContent, #worshipContent').removeClass('active');
                        $('#setlistSection').show();
                        $('#deleteSection, #favoritesSection').hide();
                        $('#praiseSetlistTab').addClass('active');
                        $('#worshipSetlistTab').removeClass('active');
                        $('#praiseSetlistSongs').show();
                        $('#worshipSetlistSongs').hide();
                        this.renderSetlist('praise');
                        $('#showSetlist').addClass('active');
                        $('#showAll, #showDelete, #showFavorites').removeClass('active');
                        if ($(window).width() <= 768) {
                            $('.sidebar').addClass('hidden');
                        }
                        this.updatePositions(); // Update panel positions
                    });

                    $('#showAll').on('click', (e) => {
                        e.preventDefault();
                        $('.sidebar-menu > li > a').removeClass('active');
                        $(e.currentTarget).addClass('active');
                        $('.songs-section').removeClass('hidden'); // Ensure songs section is visible
                        $('#praiseContent').addClass('active');
                        $('#worshipContent').removeClass('active');
                        $('#setlistSection, #deleteSection, #favoritesSection').hide();
                        this.renderSongs('praise', $('#keyFilter').val(), $('#genreFilter').val());
                        $('#showAll').addClass('active');
                        $('#showSetlist, #showDelete, #showFavorites').removeClass('active');
                        this.applyLyricsBackground(true);
                        if ($(window).width() <= 768) {
                            $('.sidebar').addClass('hidden');
                        }
                        this.updatePositions(); // Update panel positions
                    });

                    $('#showDelete').on('click', (e) => {
                        e.preventDefault();
                        $('.sidebar-menu > li > a').removeClass('active');
                        $(e.currentTarget).addClass('active');
                        $('.songs-section').removeClass('hidden'); // Ensure songs section is visible
                        $('#praiseContent, #worshipContent').removeClass('active');
                        $('#setlistSection').hide();
                        $('#deleteSection').show();
                        $('#favoritesSection').hide();
                        this.renderDeleteSongs();
                        $('#showDelete').addClass('active');
                        $('#showAll, #showSetlist, #showFavorites').removeClass('active');
                        if ($(window).width() <= 768) {
                            $('.sidebar').addClass('hidden');
                        }
                        this.updatePositions(); // Update panel positions
                    });

                    $('#showFavorites').on('click', (e) => {
                        e.preventDefault();
                        $('.sidebar-menu > li > a').removeClass('active');
                        $(e.currentTarget).addClass('active');
                        $('.songs-section').removeClass('hidden'); // Ensure songs section is visible
                        $('#praiseContent, #worshipContent').removeClass('active');
                        $('#setlistSection, #deleteSection').hide();
                        $('#favoritesSection').show();
                        this.renderFavorites();
                        $('#showFavorites').addClass('active');
                        $('#showAll, #showSetlist, #showDelete').removeClass('active');
                        if ($(window).width() <= 768) {
                            $('.sidebar').addClass('hidden');
                        }
                        this.updatePositions(); // Update panel positions
                    });

                    // Setlist tab switching
                    $('#praiseSetlistTab').on('click', () => {
                        $('#praiseSetlistTab').addClass('active');
                        $('#worshipSetlistTab').removeClass('active');
                        $('#praiseSetlistSongs').show();
                        $('#worshipSetlistSongs').hide();
                        this.renderSetlist('praise');
                    });

                    $('#worshipSetlistTab').on('click', () => {
                        $('#worshipSetlistTab').addClass('active');
                        $('#praiseSetlistTab').removeClass('active');
                        $('#worshipSetlistSongs').show();
                        $('#praiseSetlistSongs').hide();
                        this.renderSetlist('worship');
                    });

                    // Song modals
                    $('#openAddSongModal').on('click', () => {
                        $('#addSongModal').css('display', 'flex');
                        $('#selectedGenres').empty();
                        $('#genreDropdown .multiselect-option').removeClass('selected');
                    });

                    $('.close-modal').on('click', function() {
                        $(this).closest('.modal').hide();
                    });

                    // Multi-select genre functionality
                    $('#songGenre').on('click', (e) => {
                        e.preventDefault();
                        $('#genreDropdown').toggleClass('show');
                    });
                    
                    $('#editSongGenre').on('click', (e) => {
                        e.preventDefault();
                        $('#editGenreDropdown').toggleClass('show');
                    });
                    
                    // Close dropdowns when clicking outside
                    $(document).on('click', (e) => {
                        if (!$(e.target).closest('.multiselect-container').length) {
                            $('#genreDropdown, #editGenreDropdown').removeClass('show');
                        }
                    });
                    
                    // Genre selection
                    $('#genreDropdown .multiselect-option').on('click', function() {
                        $(this).toggleClass('selected');
                        app.updateSelectedGenres('selectedGenres', 'genreDropdown');
                    });
                    
                    $('#editGenreDropdown .multiselect-option').on('click', function() {
                        $(this).toggleClass('selected');
                        app.updateSelectedGenres('editSelectedGenres', 'editGenreDropdown');
                    });

                    // Form submissions
                    $('#newSongForm').on('submit', (e) => {
                        e.preventDefault();
                        const title = $('#songTitle').val();
                        const lyrics = $('#songLyrics').val();
                        
                        // Check for duplicates
                        if (this.isDuplicateSong(title, lyrics)) {
                            this.showNotification('A song with this title and lyrics already exists!');
                            return;
                        }
                        
                        // Get selected genres
                        const selectedGenres = $('#genreDropdown .multiselect-option.selected')
                            .map((i, opt) => $(opt).data('value')).get();
                        
                        if (selectedGenres.length === 0) {
                            this.showNotification('Please select at least one genre');
                            return;
                        }
                        
                        const newSong = {
                            id: Math.max(...this.songs.map(s => s.id), 0) + 1,
                            title: title,
                            category: $('#songCategory').val(),
                            key: $('#songKey').val(),
                            tempo: $('#songTempo').val(),
                            time: $('#songTime').val(),
                            taal: $('#songTaal').val(),
                            genres: selectedGenres,
                            lyrics: lyrics
                        };
                        
                        this.songs.push(newSong);
                        this.saveSongs();
                        
                        if ($('#deleteSection').css('display') === 'block') {
                            this.renderDeleteSongs();
                        } else if ($('#praiseTab').hasClass('active')) {
                            this.renderSongs('praise', $('#keyFilter').val(), $('#genreFilter').val());
                        } else {
                            this.renderSongs('worship', $('#keyFilter').val(), $('#genreFilter').val());
                        }
                        
                        this.showNotification('Song added successfully!');
                        $('#addSongModal').hide();
                        $('#newSongForm')[0].reset();
                        $('#selectedGenres').empty();
                    });

                    $('#editSongForm').on('submit', (e) => {
                        e.preventDefault();
                        const id = parseInt($('#editSongId').val());
                        const title = $('#editSongTitle').val();
                        const lyrics = $('#editSongLyrics').val();
                        
                        // Check for duplicates (excluding current song)
                        if (this.isDuplicateSong(title, lyrics, id)) {
                            this.showNotification('A song with this title and lyrics already exists!');
                            return;
                        }
                        
                        // Get selected genres
                        const selectedGenres = $('#editGenreDropdown .multiselect-option.selected')
                            .map((i, opt) => $(opt).data('value')).get();
                        
                        if (selectedGenres.length === 0) {
                            this.showNotification('Please select at least one genre');
                            return;
                        }
                        
                        const updatedSong = {
                            id,
                            title: title,
                            category: $('#editSongCategory').val(),
                            key: $('#editSongKey').val(),
                            tempo: $('#editSongTempo').val(),
                            time: $('#editSongTime').val(),
                            taal: $('#editSongTaal').val(),
                            genres: selectedGenres,
                            lyrics: lyrics
                        };

                        this.songs = this.songs.map(song => song.id === id ? updatedSong : song);
                        this.saveSongs();

                        this.praiseSetlist = this.praiseSetlist.map(song => song.id === id ? updatedSong : song);
                        this.worshipSetlist = this.worshipSetlist.map(song => song.id === id ? updatedSong : song);
                        this.saveSetlists();

                        if ($('#deleteSection').css('display') === 'block') {
                            this.renderDeleteSongs();
                        } else if ($('#setlistSection').css('display') === 'block') {
                            this.renderSetlist($('#praiseSetlistTab').hasClass('active') ? 'praise' : 'worship');
                        } else if ($('#praiseTab').hasClass('active')) {
                            this.renderSongs('praise', $('#keyFilter').val(), $('#genreFilter').val());
                        } else {
                            this.renderSongs('worship', $('#keyFilter').val(), $('#genreFilter').val());
                        }

                        if ($('#songPreview').data('songId') == id) {
                            this.showPreview(updatedSong);
                        }

                        this.showNotification('Song updated successfully!');
                        $('#editSongModal').hide();
                        $('#editSongForm')[0].reset();
                    });

                    $('#cancelDeleteSong').on('click', () => {
                        $('#deleteSongModal').hide();
                    });

                    $('#deleteSongForm').on('submit', (e) => {
                        e.preventDefault();
                        const id = parseInt($('#deleteSongId').val());
                        const song = this.songs.find(s => s.id === id);
                        
                        this.songs = this.songs.filter(s => s.id !== id);
                        this.saveSongs();

                        this.praiseSetlist = this.praiseSetlist.filter(s => s.id !== id);
                        this.worshipSetlist = this.worshipSetlist.filter(s => s.id !== id);
                        this.saveSetlists();
                        
                        // Remove from favorites if needed
                        const favIndex = this.favorites.indexOf(id);
                        if (favIndex !== -1) {
                            this.favorites.splice(favIndex, 1);
                            this.saveFavorites();
                        }

                        if ($('#songPreview').data('songId') == id) {
                            $('#songPreview').html('<h2>Select a song</h2><div class="song-lyrics"></div>');
                            $('#songPreview').removeData('songId');
                            if (this.autoScrollInterval) {
                                clearInterval(this.autoScrollInterval);
                                this.autoScrollInterval = null;
                            }
                        }

                        this.renderDeleteSongs();
                        this.showNotification(`"${song.title}" deleted successfully`);
                        $('#deleteSongModal').hide();
                    });

                    // Preview scrolling
                    const previewEl = $('#songPreview')[0];
                    if (previewEl) {
                        previewEl.addEventListener('wheel', () => this.handleUserScroll(), { passive: true });
                        previewEl.addEventListener('touchmove', () => this.handleUserScroll(), { passive: true });
                    }
                    
                    // Auto-scroll controls
                    $('#autoScrollUp').on('click', () => this.startAutoScroll('up'));
                    $('#autoScrollDown').on('click', () => this.startAutoScroll('down'));
                    $('#toggleAutoScroll').on('click', () => this.toggleAutoScroll());
                    
                    // Keep screen on button
                    $('#keepScreenOnBtn').on('click', () => this.toggleScreenWakeLock());

                    // Bulk operations
                    $('#deleteAllSongsBtn').on('click', () => {
                        $('#confirmDeleteAllModal').css('display', 'flex');
                    });

                    $('#mergeSongsBtn').on('click', () => {
                        const fileInput = $('<input type="file" accept=".json" style="display: none;">');
                        fileInput.on('change', (e) => this.handleMergeUpload(e));
                        $('body').append(fileInput);
                        fileInput.trigger('click');
                        fileInput.remove();
                    });

                    $('#cancelDeleteAll').on('click', () => {
                        $('#confirmDeleteAllModal').hide();
                    });

                    $('#confirmDeleteAll').on('click', () => {
                        this.songs = [];
                        this.praiseSetlist = [];
                        this.worshipSetlist = [];
                        this.favorites = [];
                        this.saveSongs();
                        this.saveSetlists();
                        this.saveFavorites();
                        if ($('#praiseTab').hasClass('active')) {
                            this.renderSongs('praise', $('#keyFilter').val(), $('#genreFilter').val());
                        } else {
                            this.renderSongs('worship', $('#keyFilter').val(), $('#genreFilter').val());
                        }
                        $('#songPreview').html('<h2>Select a song</h2><div class="song-lyrics"></div>');
                        $('#songPreview').removeData('songId');
                        this.showNotification('All songs have been deleted.');
                        $('#confirmDeleteAllModal').hide();
                    });

                    // Search functionality
                    $('#searchInput').on('input', (e) => {
                        const query = $(e.target).val().trim().toLowerCase();
                        $('#clearSearch').toggle(query.length > 0);
                        const searchResults = $('#searchResults');
                        const searchResultsContent = $('#searchResultsContent');

                        if (query.length === 0) {
                            searchResults.removeClass('active');
                            if ($('#praiseTab').hasClass('active')) {
                                this.renderSongs('praise', $('#keyFilter').val(), $('#genreFilter').val());
                            } else {
                                this.renderSongs('worship', $('#keyFilter').val(), $('#genreFilter').val());
                            }
                            return;
                        }

                        const filtered = this.songs.filter(song => {
                            return (
                                song.title.toLowerCase().includes(query) ||
                                (song.lyrics && song.lyrics.toLowerCase().includes(query)) ||
                                (song.taal && song.taal.toLowerCase().includes(query)) ||
                                (song.genre && song.genre.toLowerCase().includes(query)) ||
                                (song.genres && song.genres.some(g => g.toLowerCase().includes(query)))
                            );
                        });

                        if (filtered.length === 0) {
                            searchResultsContent.html('<p>No results found</p>');
                            searchResults.addClass('active');
                            return;
                        }

                        searchResultsContent.empty();

                        filtered.forEach(song => {
                            const highlightedTitle = this.highlightText(song.title, query);

                            let lyricsSnippet = '';
                            if (song.lyrics && song.lyrics.toLowerCase().includes(query)) {
                                const lyricsLower = song.lyrics.toLowerCase();
                                const queryPos = lyricsLower.indexOf(query);
                                const startPos = Math.max(0, queryPos - 20);
                                const endPos = Math.min(song.lyrics.length, queryPos + query.length + 40);
                                lyricsSnippet = song.lyrics.substring(startPos, endPos);
                                if (startPos > 0) lyricsSnippet = '...' + lyricsSnippet;
                                if (endPos < song.lyrics.length) lyricsSnippet = lyricsSnippet + '...';
                                lyricsSnippet = this.highlightText(lyricsSnippet, query);
                            }

                            const resultItem = $(`
                                <div class="search-result-item" data-song-id="${song.id}">
                                    <div class="search-result-title">${highlightedTitle}</div>
                                    <div class="search-result-meta">${song.key} | ${song.tempo} | ${song.time} | ${song.genre || ''}</div>
                                    ${lyricsSnippet ? `<div class="search-result-snippet">${lyricsSnippet}</div>` : ''}
                                </div>
                            `);

                            resultItem.on('click', () => {
                                const foundSong = this.songs.find(s => s.id === song.id);
                                if (foundSong) {
                                    this.showPreview(foundSong);
                                    if ($(window).width() <= 768) {
                                        $('.sidebar').addClass('hidden'); // Hide sidebar after selection on mobile
                                        $('.songs-section, .sidebar').addClass('hidden');
                                        $('.preview-section').addClass('full-width');
                                    }
                                }
                            });

                            searchResultsContent.append(resultItem);
                        });

                        searchResults.addClass('active');
                    });
                    
                    // Clear search button
                    $('#clearSearch').on('click', () => {
                        $('#searchInput').val('');
                        $('#clearSearch').hide();
                        $('#searchResults').removeClass('active');
                        if ($('#praiseTab').hasClass('active')) {
                            this.renderSongs('praise', $('#keyFilter').val(), $('#genreFilter').val());
                        } else {
                            this.renderSongs('worship', $('#keyFilter').val(), $('#genreFilter').val());
                        }
                    });
                    
                    // Search history dropdown
                    $('#searchInput').on('focus', () => {
                        if ($('#searchInput').val().trim() === '') {
                            this.showSearchHistory();
                        }
                    });
                    
                    $(document).on('click', (e) => {
                        if (!$(e.target).closest('.search-container').length) {
                            $('#searchHistoryDropdown').hide();
                        }
                    });

                    // Download/upload
                    $('#downloadSongsBtn').on('click', () => this.downloadSongs());
                    $('#uploadSongsBtn').on('click', () => {
                        const fileInput = $('<input type="file" accept=".json" style="display: none;">');
                        fileInput.on('change', (e) => this.handleFileUpload(e));
                        $('body').append(fileInput);
                        fileInput.trigger('click');
                        fileInput.remove();
                    });

                    // HTML download
                    $('#downloadHtmlWithSongsBtn').on('click', () => {
                        try {
                            const clone = $('html').clone();
                            const embedded = clone.find('#embeddedSongs');
                            if (embedded.length) {
                                embedded.text(JSON.stringify(this.songs, null, 2));
                            } else {
                                const script = $('<script id="embeddedSongs" type="application/json">')
                                    .text(JSON.stringify(this.songs, null, 2));
                                clone.find('body').append(script);
                            }

                            const fullHtml = '<!DOCTYPE html>\n' + clone[0].outerHTML;
                            const blob = new Blob([fullHtml], { type: 'text/html' });
                            const a = document.createElement('a');
                            a.href = URL.createObjectURL(blob);
                            a.download = 'PraiseWorship_Songs_Updated.html';
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(a.href);
                            this.showNotification('HTML file downloaded with all songs');
                        } catch (err) {
                            this.showNotification('Failed to generate updated HTML: ' + err.message);
                        }
                    });

                    // Settings
                    const settingsBtn = $('<button id="settingsBtn">🛠</button>');
                    $('.app-container').append(settingsBtn);

                    settingsBtn.on('click', () => {
                        $('#sidebarHeaderInput').val($('.sidebar-header h2').text());
                        $('#setlistTextInput').val($('#showSetlist').text());
                        $('#settingsModal').css('display', 'flex');
                    });

                    $('#settingsForm').on('submit', (e) => {
                        e.preventDefault();
                        this.saveSettings();
                        this.showNotification('Settings saved successfully');
                        $('#settingsModal').hide();
                    });

                    // Folder toggle
                    $('#toggleSongTools').on('click', () => {
                        $('#songToolsContent').toggleClass('show');
                        $('#toggleSongTools').toggleClass('active');
                    });

                    // Suggested songs
                    $('#toggleSuggestedSongs').on('click', () => this.toggleSuggestedSongsDrawer());
                    $('#closeSuggestedSongs').on('click', () => this.closeSuggestedSongsDrawer());
                    $(document).on('click', (e) => {
                        const drawer = $('#suggestedSongsDrawer');
                        const toggleBtn = $('#toggleSuggestedSongs');
                        
                        if (this.suggestedSongsDrawerOpen && 
                            !$(e.target).closest('#suggestedSongsDrawer').length && 
                            !$(e.target).is(toggleBtn)) {
                            this.closeSuggestedSongsDrawer();
                        }
                    });

                    // Make toggle buttons draggable
                    this.makeToggleDraggable('toggle-sidebar');
                    this.makeToggleDraggable('toggle-songs');
                    this.makeToggleDraggable('toggle-all-panels');
                },

                updateSelectedGenres: function(containerId, dropdownId) {
                    const container = $(`#${containerId}`);
                    container.empty();
                    
                    $(`#${dropdownId} .multiselect-option.selected`).each((i, opt) => {
                        const genre = $(opt).data('value');
                        const tag = $(`
                            <div class="multiselect-tag">
                                ${genre}
                                <span class="remove-tag">×</span>
                            </div>
                        `);
                        container.append(tag);
                        
                        // Add remove functionality
                        tag.find('.remove-tag').on('click', (e) => {
                            e.stopPropagation();
                            $(opt).removeClass('selected');
                            tag.remove();
                        });
                    });
                },

                makeToggleDraggable: function(id) {
                    const el = $(`#${id}`);
                    let isDragging = false, offsetX = 0, offsetY = 0;

                    const savePosition = () => {
                        const pos = { top: el.css('top'), left: el.css('left') };
                        localStorage.setItem(`${id}-pos`, JSON.stringify(pos));
                    };

                    const restorePosition = () => {
                        const saved = localStorage.getItem(`${id}-pos`);
                        if (saved) {
                            const pos = JSON.parse(saved);
                            el.css({ top: pos.top, left: pos.left });
                        } else {
                            // Default positions
                            if (id === 'toggle-sidebar') {
                                el.css({ top: '100px', left: '10px' });
                            } else if (id === 'toggle-songs') {
                                el.css({ top: '150px', left: '10px' });
                            } else if (id === 'toggle-all-panels') {
                                el.css({ top: '200px', left: '10px' });
                            }
                        }
                    };

                    el.on('mousedown', function(e) {
                        isDragging = true;
                        offsetX = e.clientX - el.offset().left;
                        offsetY = e.clientY - el.offset().top;
                        $('body').css('user-select', 'none');
                    });

                    $(document).on('mousemove', (e) => {
                        if (isDragging) {
                            el.css({
                                left: e.clientX - offsetX + 'px',
                                top: e.clientY - offsetY + 'px'
                            });
                        }
                    });

                    $(document).on('mouseup', () => {
                        isDragging = false;
                        $('body').css('user-select', '');
                        const windowWidth = $(window).width();
                        const elRect = el[0].getBoundingClientRect();
                        if (elRect.left < windowWidth / 2) {
                            el.css('left', '10px');
                        } else {
                            el.css('left', (windowWidth - el.outerWidth() - 10) + 'px');
                        }
                        savePosition();
                    });

                    el.on('touchstart', function(e) {
                        isDragging = true;
                        const touch = e.originalEvent.touches[0];
                        offsetX = touch.clientX - el.offset().left;
                        offsetY = touch.clientY - el.offset().top;
                    });

                    el.on('touchmove', function(e) {
                        if (isDragging) {
                            const touch = e.originalEvent.touches[0];
                            el.css({
                                left: touch.clientX - offsetX + 'px',
                                top: touch.clientY - offsetY + 'px'
                            });
                        }
                    });

                    el.on('touchend', () => {
                        isDragging = false;
                        const windowWidth = $(window).width();
                        const elRect = el[0].getBoundingClientRect();
                        if (elRect.left < windowWidth / 2) {
                            el.css('left', '10px');
                        } else {
                            el.css('left', (windowWidth - el.outerWidth() - 10) + 'px');
                        }
                        savePosition();
                    });

                    restorePosition();

                    let timeout;
                    const showTemporarily = () => {
                        el.addClass('showing');
                        clearTimeout(timeout);
                        timeout = setTimeout(() => el.removeClass('showing'), 3000);
                    };

                    el.on('mouseenter', () => el.addClass('showing'))
                      .on('mouseleave', () => el.removeClass('showing'))
                      .on('touchstart', showTemporarily);
                }
            };

            // Initialize the application
            app.init();

            // Make app functions available globally
            window.addToSetlist = (id) => app.addToSetlist(id);
            window.editSong = (id) => app.editSong(id);
            window.openDeleteSongModal = (id) => app.openDeleteSongModal(id);
            window.removeFromSetlist = (id, category) => app.removeFromSetlist(id, category);
            window.renderSetlist = (category) => app.renderSetlist(category);
        });
    </script>
</body>
</html>
